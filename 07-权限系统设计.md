# 18. 权限系统设计

---

## 目录

- [1. 设计理念](#1-设计理念)
- [2. 角色与状态分离](#2-角色与状态分离)
- [3. 权限位掩码](#3-权限位掩码)
- [4. 权限继承机制](#4-权限继承机制)
- [5. 权限检查实现](#5-权限检查实现)
- [6. 数据模型](#6-数据模型)
- [7. 最佳实践](#7-最佳实践)
- [8. Allow/Deny 权限模式设计理由](#8-allowdeny-权限模式设计理由)

---

## 1. 设计理念

### 1.1 设计目标

参考 **Telegram** 的权限系统,实现:

- **角色与状态分离**: Role (角色) 和 Status (状态) 是独立的概念
- **清晰的权限继承**: Creator → Custom → Role Default → Room Default
- **细粒度控制**: 64 位权限位掩码支持复杂场景
- **灵活配置**: 创建者可自定义房间默认权限和个人权限
- **默认安全**: 遵循最小权限原则

### 1.2 核心概念

```
┌─────────────────────────────────────────────────────────┐
│                      全局层                             │
│                                                         │
│  UserRole (角色):        Root | Admin | User            │
│  UserStatus (状态):      Active | Pending | Banned      │
│                                                         │
└─────────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────┐
│                      房间层                             │
│                                                         │
│  RoomRole (角色):        Creator | Admin | Member | Guest│
│  MemberStatus (状态):    Active | Pending | Banned      │
│                                                         │
│  权限继承链:                                             │
│  Creator → Custom Permissions → Role Default → Room Default│
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 角色与状态分离

### 2.1 全局用户角色与状态

#### 2.1.1 用户角色 (UserRole)

**角色代表用户的权限级别,与状态无关**

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum UserRole {
    /// Root 用户 (超级管理员)
    /// - 可以管理所有管理员
    /// - 可以访问所有房间
    /// - 可以修改全局设置
    Root,

    /// 平台管理员
    /// - 可以管理普通用户 (批准、封禁、删除)
    /// - 可以管理房间 (批准、封禁、删除)
    /// - 无法管理 Root 用户
    Admin,

    /// 普通用户
    /// - 可以创建房间 (受全局配置限制)
    /// - 可以加入房间
    User,
}

impl UserRole {
    /// 检查是否可以管理另一个角色
    pub fn can_manage(&self, other: &UserRole) -> bool {
        match (self, other) {
            (UserRole::Root, _) => true,
            (UserRole::Admin, UserRole::User) => true,
            _ => false,
        }
    }

    /// 检查是否是管理员或更高权限
    pub fn is_admin_or_above(&self) -> bool {
        matches!(self, UserRole::Root | UserRole::Admin)
    }
}
```

#### 2.1.2 用户状态 (UserStatus)

**状态代表用户的账号状态,与角色无关**

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum UserStatus {
    /// 正常激活状态
    /// - 可以正常登录和使用所有功能
    Active,

    /// 待审核状态
    /// - 注册后等待管理员批准
    /// - 可以登录但无法创建或加入房间
    Pending,

    /// 封禁状态
    /// - 无法登录
    /// - 所有操作被禁止
    Banned,
}

impl UserStatus {
    /// 检查是否可以登录
    pub fn can_login(&self) -> bool {
        matches!(self, UserStatus::Active | UserStatus::Pending)
    }

    /// 检查是否可以创建房间
    pub fn can_create_room(&self) -> bool {
        matches!(self, UserStatus::Active)
    }

    /// 检查是否可以加入房间
    pub fn can_join_room(&self) -> bool {
        matches!(self, UserStatus::Active)
    }
}
```

#### 2.1.3 用户模型

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct User {
    pub id: Uuid,
    pub username: String,
    pub email: String,

    /// 用户角色 (权限级别)
    pub role: UserRole,

    /// 用户状态 (账号状态)
    pub status: UserStatus,

    pub created_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,
}
```

### 2.2 房间角色与状态

#### 2.2.1 房间角色 (RoomRole)

**房间内的角色,决定用户在房间内的权限级别**

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum RoomRole {
    /// 房间创建者
    /// - 拥有房间的所有权限 (固定,无法修改)
    /// - 可以提升/降级管理员
    /// - 可以设置房间默认权限
    /// - 可以删除房间
    Creator,

    /// 房间管理员
    /// - 权限由创建者配置 (可自定义)
    /// - 默认可以管理成员、设置房间
    /// - 无法管理创建者
    Admin,

    /// 普通成员
    /// - 权限由创建者配置 (可自定义)
    /// - 默认可以聊天、观看视频
    Member,

    /// 游客 (临时用户,不保存到数据库)
    /// - 使用房间的游客权限配置
    /// - 通常只能观看,不能聊天
    Guest,
}
```

#### 2.2.2 房间成员状态 (MemberStatus)

**成员在房间内的状态,与角色无关**

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]
#[serde(rename_all = "lowercase")]
pub enum MemberStatus {
    /// 正常成员
    Active,

    /// 待审核 (如果房间启用审核)
    Pending,

    /// 被房间封禁
    Banned,
}
```

#### 2.2.3 房间成员模型

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct RoomMember {
    pub id: Uuid,
    pub room_id: String,  // nanoid
    pub user_id: Uuid,

    /// 房间角色 (权限级别)
    pub role: RoomRole,

    /// 成员状态
    pub status: MemberStatus,

    /// Allow/Deny 权限模式
    /// - 最终权限 = (角色默认 | added_permissions) & ~removed_permissions
    /// - None = 不修改该项

    /// 额外添加的权限（在角色默认之上）
    /// - None: 不添加任何额外权限
    /// - Some(bits): 添加指定权限
    pub added_permissions: Option<u64>,

    /// 移除的权限（从角色默认中移除）
    /// - None: 不移除任何权限
    /// - Some(bits): 移除指定权限
    pub removed_permissions: Option<u64>,

    /// 用于乐观锁
    pub version: i64,

    pub joined_at: DateTime<Utc>,
    pub updated_at: DateTime<Utc>,

    // 封禁相关
    pub banned_at: Option<DateTime<Utc>>,
    pub banned_by: Option<Uuid>,
    pub banned_reason: Option<String>,
}
```

### 2.3 全局权限矩阵

| 操作 | Root | Admin | User | 状态要求 |
|-----|------|-------|------|---------|
| 登录系统 | ✅ | ✅ | ✅ | Active 或 Pending |
| 创建房间 | ✅ | ✅ | ✅ (可配置) | Active |
| 加入房间 | ✅ | ✅ | ✅ | Active |
| 管理普通用户 | ✅ | ✅ | ❌ | Active |
| 管理管理员 | ✅ | ❌ | ❌ | Active |
| 管理房间 | ✅ | ✅ | ❌ | Active |
| 修改全局设置 | ✅ | ✅ (部分) | ❌ | Active |
| 查看审计日志 | ✅ | ✅ | ❌ | Active |

**关键点**:

- Role (Root/Admin/User) 决定 **权限级别**
- Status (Active/Pending/Banned) 决定 **能否执行操作**
- 两者独立检查: `if user.role.is_admin_or_above() && user.status == UserStatus::Active`

---

## 3. 权限位掩码

### 3.1 权限位定义

使用 64 位整数,每一位代表一个权限:

```rust
pub struct Permissions(pub u64);

impl Permissions {
    // ===== 内容管理权限 (0-9) =====

    /// 发送聊天消息
    pub const SEND_CHAT: u64 = 1 << 0;

    /// 添加电影到播放列表
    pub const ADD_MOVIE: u64 = 1 << 1;

    /// 删除自己添加的电影
    pub const DELETE_MOVIE_SELF: u64 = 1 << 2;

    /// 删除任意电影
    pub const DELETE_MOVIE_ANY: u64 = 1 << 3;

    /// 编辑自己添加的电影信息
    pub const EDIT_MOVIE_SELF: u64 = 1 << 4;

    /// 编辑任意电影信息
    pub const EDIT_MOVIE_ANY: u64 = 1 << 5;

    /// 调整播放列表顺序
    pub const REORDER_PLAYLIST: u64 = 1 << 6;

    /// 清空播放列表
    pub const CLEAR_PLAYLIST: u64 = 1 << 7;

    // ===== 播放控制权限 (10-19) =====

    /// 播放控制 (播放/暂停/跳转)
    pub const PLAY_CONTROL: u64 = 1 << 10;

    /// 切换当前播放的电影
    pub const CHANGE_CURRENT_MOVIE: u64 = 1 << 11;

    /// 调整播放速度
    pub const CHANGE_PLAYBACK_RATE: u64 = 1 << 12;

    // ===== 成员管理权限 (20-29) =====

    /// 批准待审核成员
    pub const APPROVE_MEMBER: u64 = 1 << 20;

    /// 踢出成员
    pub const KICK_MEMBER: u64 = 1 << 21;

    /// 封禁/解封成员
    pub const BAN_MEMBER: u64 = 1 << 22;

    /// 修改成员权限
    pub const SET_MEMBER_PERMISSIONS: u64 = 1 << 23;

    /// 提升/降级管理员
    pub const MANAGE_ADMIN: u64 = 1 << 24;

    // ===== 房间管理权限 (30-39) =====

    /// 修改房间设置
    pub const SET_ROOM_SETTINGS: u64 = 1 << 30;

    /// 修改房间密码
    pub const SET_ROOM_PASSWORD: u64 = 1 << 31;

    /// 删除任意聊天消息
    pub const DELETE_CHAT: u64 = 1 << 32;

    /// 查看房间统计信息
    pub const VIEW_STATS: u64 = 1 << 33;

    /// 导出房间数据
    pub const EXPORT_DATA: u64 = 1 << 34;

    /// 删除房间
    pub const DELETE_ROOM: u64 = 1 << 35;

    // ===== 查看权限 (40-49) =====

    /// 查看播放列表
    pub const VIEW_PLAYLIST: u64 = 1 << 40;

    /// 查看成员列表
    pub const VIEW_MEMBER_LIST: u64 = 1 << 41;

    /// 查看聊天历史
    pub const VIEW_CHAT_HISTORY: u64 = 1 << 42;

    // ===== 通信权限 (50-59) =====

    /// 使用 WebRTC (语音/视频通话)
    pub const USE_WEBRTC: u64 = 1 << 50;

    // ===== 预留权限 (60-63) =====
    // 可用于未来扩展

    // ===== 权限组合 =====

    /// 所有权限 (创建者专用)
    pub const ALL: u64 = u64::MAX;

    /// 默认成员权限
    pub const DEFAULT_MEMBER: u64 = Self::SEND_CHAT
        | Self::ADD_MOVIE
        | Self::DELETE_MOVIE_SELF
        | Self::EDIT_MOVIE_SELF
        | Self::VIEW_PLAYLIST
        | Self::VIEW_MEMBER_LIST
        | Self::VIEW_CHAT_HISTORY;

    /// 默认管理员权限
    pub const DEFAULT_ADMIN: u64 = Self::DEFAULT_MEMBER
        | Self::DELETE_MOVIE_ANY
        | Self::EDIT_MOVIE_ANY
        | Self::REORDER_PLAYLIST
        | Self::CLEAR_PLAYLIST
        | Self::PLAY_CONTROL
        | Self::CHANGE_CURRENT_MOVIE
        | Self::CHANGE_PLAYBACK_RATE
        | Self::APPROVE_MEMBER
        | Self::KICK_MEMBER
        | Self::BAN_MEMBER
        | Self::SET_ROOM_SETTINGS
        | Self::SET_ROOM_PASSWORD
        | Self::DELETE_CHAT
        | Self::VIEW_STATS;

    /// 默认游客权限 (只读)
    pub const DEFAULT_GUEST: u64 = Self::VIEW_PLAYLIST;

    // ===== 权限操作 =====

    /// 检查是否拥有某个权限
    pub fn has(&self, permission: u64) -> bool {
        (self.0 & permission) != 0
    }

    /// 检查是否拥有所有指定权限
    pub fn has_all(&self, permissions: u64) -> bool {
        (self.0 & permissions) == permissions
    }

    /// 检查是否拥有任意一个指定权限
    pub fn has_any(&self, permissions: u64) -> bool {
        (self.0 & permissions) != 0
    }

    /// 添加权限
    pub fn add(&mut self, permission: u64) {
        self.0 |= permission;
    }

    /// 移除权限
    pub fn remove(&mut self, permission: u64) {
        self.0 &= !permission;
    }

    /// 切换权限
    pub fn toggle(&mut self, permission: u64) {
        self.0 ^= permission;
    }
}
```

### 3.2 权限分组

为了方便管理,将权限分为不同的组:

```rust
pub struct PermissionGroups;

impl PermissionGroups {
    /// 内容管理权限组
    pub const CONTENT_MANAGEMENT: u64 = Permissions::ADD_MOVIE
        | Permissions::DELETE_MOVIE_SELF
        | Permissions::DELETE_MOVIE_ANY
        | Permissions::EDIT_MOVIE_SELF
        | Permissions::EDIT_MOVIE_ANY
        | Permissions::REORDER_PLAYLIST
        | Permissions::CLEAR_PLAYLIST;

    /// 播放控制权限组
    pub const PLAYBACK_CONTROL: u64 = Permissions::PLAY_CONTROL
        | Permissions::CHANGE_CURRENT_MOVIE
        | Permissions::CHANGE_PLAYBACK_RATE;

    /// 成员管理权限组
    pub const MEMBER_MANAGEMENT: u64 = Permissions::APPROVE_MEMBER
        | Permissions::KICK_MEMBER
        | Permissions::BAN_MEMBER
        | Permissions::SET_MEMBER_PERMISSIONS
        | Permissions::MANAGE_ADMIN;

    /// 房间管理权限组
    pub const ROOM_MANAGEMENT: u64 = Permissions::SET_ROOM_SETTINGS
        | Permissions::SET_ROOM_PASSWORD
        | Permissions::DELETE_CHAT
        | Permissions::VIEW_STATS
        | Permissions::EXPORT_DATA
        | Permissions::DELETE_ROOM;
}
```

---

## 4. 权限继承机制

### 4.1 继承链

```
Creator (创建者)
    ↓
    拥有所有权限 (固定,无法修改)
    Permissions::ALL

Admin/Member 权限计算:
    ↓
1. 获取角色基础权限
    ↓
    房间配置: room.settings.default_[role]_permissions
    如果为0 ↓
    全局默认: Permissions::DEFAULT_[ROLE]
    ↓
2. 应用 Allow/Deny 修改
    ↓
    base_permissions  (角色基础权限)
    | added_permissions  (额外添加的权限)
    & ~removed_permissions  (移除的权限)
    ↓
3. 最终权限
    ↓
    effective_permissions

Guest (游客)
    ↓
    使用游客权限配置 (固定)
    room.settings.guest_permissions
```

### 4.2 权限计算实现

```rust
impl RoomMember {
    /// 计算用户的有效权限
    ///
    /// 权限继承链:
    /// 1. Creator → 所有权限 (固定)
    /// 2. Allow/Deny → 角色默认 + 额外添加 - 移除
    /// 3. Role Default → 角色默认权限 (房间配置)
    /// 4. Global Default → 全局默认权限 (代码内置)
    pub fn effective_permissions(&self, room: &Room) -> Permissions {
        match self.role {
            // 1. 创建者拥有所有权限 (固定)
            RoomRole::Creator => {
                return Permissions(Permissions::ALL);
            }

            // 2. 游客使用房间游客权限配置
            RoomRole::Guest => {
                return Permissions(room.settings.guest_permissions);
            }

            // 3. 管理员和成员使用 Allow/Deny 模式
            RoomRole::Admin | RoomRole::Member => {
                // 3.1 获取角色基础权限
                let base = self.get_role_base_permissions(room);

                // 3.2 应用增量修改
                let mut result = base;

                // 添加额外权限
                if let Some(added) = self.added_permissions {
                    result |= added;
                }

                // 移除权限
                if let Some(removed) = self.removed_permissions {
                    result &= !removed;
                }

                Permissions(result)
            }
        }
    }

    /// 获取角色基础权限（不包含自定义修改）
    fn get_role_base_permissions(&self, room: &Room) -> u64 {
        // 1. 尝试使用房间配置的角色默认权限
        let role_default = match self.role {
            RoomRole::Admin => room.settings.default_admin_permissions,
            RoomRole::Member => room.settings.default_member_permissions,
            _ => 0,
        };

        if role_default != 0 {
            return role_default;
        }

        // 2. 使用全局默认权限
        match self.role {
            RoomRole::Admin => Permissions::DEFAULT_ADMIN,
            RoomRole::Member => Permissions::DEFAULT_MEMBER,
            _ => 0,
        }
    }

    /// 检查是否拥有指定权限
    pub fn has_permission(&self, room: &Room, permission: u64) -> bool {
        // 1. 检查成员状态
        if self.status != MemberStatus::Active {
            return false;
        }

        // 2. 计算有效权限并检查
        self.effective_permissions(room).has(permission)
    }
}
```

### 4.3 权限示例

#### 示例 1: 使用全局默认权限

```rust
let member = RoomMember {
    role: RoomRole::Member,
    added_permissions: None,    // 无额外权限
    removed_permissions: None,  // 无移除权限
    ..Default::default()
};

let room = Room {
    settings: RoomSettings {
        default_member_permissions: 0,  // 未配置房间默认权限
        ..Default::default()
    },
    ..Default::default()
};

// 结果: 使用 Permissions::DEFAULT_MEMBER
let perms = member.effective_permissions(&room);
assert_eq!(perms.0, Permissions::DEFAULT_MEMBER);
```

#### 示例 2: 移除权限

```rust
// Bob是Member，禁止聊天
let member = RoomMember {
    role: RoomRole::Member,
    added_permissions: None,
    removed_permissions: Some(Permissions::SEND_CHAT),  // 移除聊天权限
    ..Default::default()
};

// 结果: DEFAULT_MEMBER & !SEND_CHAT
let perms = member.effective_permissions(&room);
assert!(!perms.has(Permissions::SEND_CHAT));
assert!(perms.has(Permissions::ADD_MOVIE));
```

#### 示例 3: 添加权限

```rust
// Alice是Member，额外添加管理员权限
let member = RoomMember {
    role: RoomRole::Member,
    added_permissions: Some(Permissions::KICK_MEMBER | Permissions::BAN_MEMBER),
    removed_permissions: None,
    ..Default::default()
};

// 结果: DEFAULT_MEMBER | KICK_MEMBER | BAN_MEMBER
let perms = member.effective_permissions(&room);
assert!(perms.has(Permissions::SEND_CHAT));      // Member默认
assert!(perms.has(Permissions::KICK_MEMBER));    // 额外添加
assert!(perms.has(Permissions::BAN_MEMBER));     // 额外添加
```

#### 示例 4: 同时添加和移除

```rust
// Charlie是Admin，移除删除权限但添加导出权限
let member = RoomMember {
    role: RoomRole::Admin,
    added_permissions: Some(Permissions::EXPORT_DATA),
    removed_permissions: Some(Permissions::DELETE_ROOM),
    ..Default::default()
};

// 结果: (DEFAULT_ADMIN | EXPORT_DATA) & !DELETE_ROOM
let perms = member.effective_permissions(&room);
assert!(perms.has(Permissions::KICK_MEMBER));    // Admin默认
assert!(perms.has(Permissions::EXPORT_DATA));    // 额外添加
assert!(!perms.has(Permissions::DELETE_ROOM));   // 已移除
```

---

## 5. 权限检查实现

### 5.1 全局权限检查

```rust
/// 检查全局管理员权限
pub async fn require_admin(
    Extension(user): Extension<User>,
) -> Result<(), StatusCode> {
    // 1. 检查角色
    if !user.role.is_admin_or_above() {
        return Err(StatusCode::FORBIDDEN);
    }

    // 2. 检查状态
    if user.status != UserStatus::Active {
        return Err(StatusCode::FORBIDDEN);
    }

    Ok(())
}

/// 检查用户是否可以创建房间
pub async fn can_create_room(user: &User, config: &Config) -> bool {
    // 1. 检查状态
    if !user.status.can_create_room() {
        return false;
    }

    // 2. 根据角色检查
    match user.role {
        UserRole::Root | UserRole::Admin => true,
        UserRole::User => config.allow_user_create_room,
    }
}
```

### 5.2 房间权限检查

```rust
/// 检查房间权限
pub async fn require_room_permission(
    user: &User,
    room: &Room,
    required_permission: u64,
) -> Result<(), Error> {
    // 1. 全局管理员绕过房间权限检查
    if user.role.is_admin_or_above() && user.status == UserStatus::Active {
        return Ok(());
    }

    // 2. 检查用户状态
    if user.status != UserStatus::Active {
        return Err(Error::UserNotActive);
    }

    // 3. 获取用户在房间的成员信息
    let member = room
        .get_member(user.id)
        .await
        .ok_or(Error::NotRoomMember)?;

    // 4. 检查成员状态
    if member.status != MemberStatus::Active {
        return Err(Error::MemberNotActive);
    }

    // 5. 检查权限
    if !member.has_permission(room, required_permission) {
        return Err(Error::PermissionDenied);
    }

    Ok(())
}
```

### 5.3 权限检查示例

```rust
/// 示例 1: 发送聊天消息
#[axum::debug_handler]
pub async fn send_chat_message(
    Extension(user): Extension<User>,
    Extension(room): Extension<Room>,
    Json(payload): Json<SendChatRequest>,
) -> Result<StatusCode> {
    // 权限检查
    require_room_permission(&user, &room, Permissions::SEND_CHAT).await?;

    // 业务逻辑
    room.send_chat_message(user.id, payload.message).await?;

    Ok(StatusCode::NO_CONTENT)
}

/// 示例 2: 封禁成员 (需要管理员权限)
#[axum::debug_handler]
pub async fn ban_member(
    Extension(user): Extension<User>,
    Extension(room): Extension<Room>,
    Json(payload): Json<BanMemberRequest>,
) -> Result<StatusCode> {
    // 1. 检查是否有封禁权限
    require_room_permission(&user, &room, Permissions::BAN_MEMBER).await?;

    // 2. 获取操作者和目标成员信息
    let operator = room.get_member(user.id).await.unwrap();
    let target = room
        .get_member(payload.user_id)
        .await
        .ok_or(Error::MemberNotFound)?;

    // 3. 不能封禁创建者
    if target.role == RoomRole::Creator {
        return Err(Error::CannotBanCreator.into());
    }

    // 4. 管理员不能封禁其他管理员 (只有创建者可以)
    if operator.role == RoomRole::Admin && target.role == RoomRole::Admin {
        return Err(Error::CannotBanAdmin.into());
    }

    // 5. 业务逻辑
    room.ban_member(payload.user_id, user.id, payload.reason)
        .await?;

    Ok(StatusCode::NO_CONTENT)
}

/// 示例 3: 修改成员权限
#[axum::debug_handler]
pub async fn set_member_permissions(
    Extension(user): Extension<User>,
    Extension(room): Extension<Room>,
    Path(member_id): Path<Uuid>,
    Json(payload): Json<SetPermissionsRequest>,
) -> Result<StatusCode> {
    // 1. 检查是否有修改权限的权限
    require_room_permission(&user, &room, Permissions::SET_MEMBER_PERMISSIONS).await?;

    // 2. 获取目标成员
    let target = room
        .get_member(member_id)
        .await
        .ok_or(Error::MemberNotFound)?;

    // 3. 不能修改创建者权限
    if target.role == RoomRole::Creator {
        return Err(Error::CannotModifyCreator.into());
    }

    // 4. 管理员只能修改普通成员权限
    let operator = room.get_member(user.id).await.unwrap();
    if operator.role == RoomRole::Admin && target.role != RoomRole::Member {
        return Err(Error::CannotModifyAdmin.into());
    }

    // 5. 业务逻辑
    room.set_member_permissions(member_id, payload.permissions)
        .await?;

    Ok(StatusCode::NO_CONTENT)
}
```

---

## 6. 数据模型

### 6.1 用户表

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(20) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,

    -- 角色和状态分离
    role VARCHAR(20) NOT NULL DEFAULT 'user',
    status VARCHAR(20) NOT NULL DEFAULT 'pending',

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- 约束
    CHECK (role IN ('root', 'admin', 'user')),
    CHECK (status IN ('active', 'pending', 'banned'))
);

CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_role_status ON users(role, status);
```

### 6.2 房间成员表

```sql
CREATE TABLE room_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id VARCHAR(36) NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

    -- 角色和状态分离
    role VARCHAR(20) NOT NULL DEFAULT 'member',
    status VARCHAR(20) NOT NULL DEFAULT 'active',

    -- Allow/Deny 权限模式 (NULL = 使用角色默认权限)
    -- 最终权限 = (角色默认 | added_permissions) & ~removed_permissions
    added_permissions BIGINT,      -- 额外添加的权限（在角色默认之上）
    removed_permissions BIGINT,    -- 移除的权限（从角色默认中移除）

    joined_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    -- 封禁信息
    banned_at TIMESTAMPTZ,
    banned_by UUID REFERENCES users(id),
    banned_reason TEXT,

    -- 用于乐观锁
    version BIGINT NOT NULL DEFAULT 0,

    UNIQUE (room_id, user_id),

    -- 约束
    CHECK (role IN ('creator', 'admin', 'member')),
    CHECK (status IN ('active', 'pending', 'banned'))
);

CREATE INDEX idx_room_members_room_id ON room_members(room_id);
CREATE INDEX idx_room_members_user_id ON room_members(user_id);
CREATE INDEX idx_room_members_role ON room_members(room_id, role);
CREATE INDEX idx_room_members_status ON room_members(room_id, status);
CREATE INDEX idx_room_members_version ON room_members(room_id, user_id, version);
```

### 6.3 房间设置表

```sql
CREATE TABLE room_settings (
    id VARCHAR(36) PRIMARY KEY REFERENCES rooms(id) ON DELETE CASCADE,

    -- 权限配置
    default_member_permissions BIGINT NOT NULL DEFAULT 0,
    default_admin_permissions BIGINT NOT NULL DEFAULT 0,
    guest_permissions BIGINT NOT NULL DEFAULT 0,

    -- 加入房间设置
    enable_guest BOOLEAN NOT NULL DEFAULT FALSE,
    require_approval BOOLEAN NOT NULL DEFAULT FALSE,
    allow_auto_join BOOLEAN NOT NULL DEFAULT TRUE,

    -- 房间保护
    enable_password BOOLEAN NOT NULL DEFAULT FALSE,
    max_members INTEGER,

    -- 其他设置
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);
```

### 6.4 权限变更日志表

```sql
CREATE TABLE permission_change_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    room_id VARCHAR(36) NOT NULL REFERENCES rooms(id) ON DELETE CASCADE,
    target_user_id UUID NOT NULL REFERENCES users(id),
    changed_by UUID NOT NULL REFERENCES users(id),

    change_type VARCHAR(50) NOT NULL,  -- role_change, permissions_change, status_change
    old_value JSONB,
    new_value JSONB,
    reason TEXT,

    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_permission_logs_room_id ON permission_change_logs(room_id);
CREATE INDEX idx_permission_logs_target_user ON permission_change_logs(target_user_id);
CREATE INDEX idx_permission_logs_changed_by ON permission_change_logs(changed_by);
CREATE INDEX idx_permission_logs_created_at ON permission_change_logs(created_at);
```

---

## 7. 最佳实践

### 7.1 权限预设模板

```rust
/// 权限预设模板 (类似 Telegram)
pub enum PermissionTemplate {
    /// 公开房间 - 所有人都可以聊天和添加电影
    Public,

    /// 私密房间 - 仅成员可以聊天,管理员控制播放
    Private,

    /// 影院模式 - 仅创建者/管理员可以控制播放
    Theater,

    /// 自定义
    Custom,
}

impl PermissionTemplate {
    pub fn member_permissions(&self) -> u64 {
        match self {
            Self::Public => {
                Permissions::SEND_CHAT
                    | Permissions::ADD_MOVIE
                    | Permissions::DELETE_MOVIE_SELF
                    | Permissions::EDIT_MOVIE_SELF
                    | Permissions::VIEW_PLAYLIST
                    | Permissions::VIEW_MEMBER_LIST
                    | Permissions::VIEW_CHAT_HISTORY
            }
            Self::Private => {
                Permissions::SEND_CHAT
                    | Permissions::VIEW_PLAYLIST
                    | Permissions::VIEW_MEMBER_LIST
                    | Permissions::VIEW_CHAT_HISTORY
            }
            Self::Theater => {
                Permissions::SEND_CHAT
                    | Permissions::VIEW_PLAYLIST
                    | Permissions::VIEW_CHAT_HISTORY
            }
            Self::Custom => Permissions::DEFAULT_MEMBER,
        }
    }

    pub fn admin_permissions(&self) -> u64 {
        Permissions::DEFAULT_ADMIN
    }

    pub fn guest_permissions(&self) -> u64 {
        Permissions::DEFAULT_GUEST
    }
}
```

### 7.2 创建房间时设置默认权限

```rust
impl Room {
    /// 创建房间时设置合理的默认权限
    pub async fn create(
        creator_id: Uuid,
        name: String,
        template: PermissionTemplate,
    ) -> Result<Self> {
        let room = Self {
            id: generate_room_id(),
            name,
            creator_id,
            settings: RoomSettings {
                default_member_permissions: template.member_permissions(),
                default_admin_permissions: template.admin_permissions(),
                guest_permissions: template.guest_permissions(),
                ..Default::default()
            },
            ..Default::default()
        };

        // 保存到数据库
        room.save().await?;

        // 将创建者添加为成员
        room.add_member(RoomMember {
            room_id: room.id.clone(),
            user_id: creator_id,
            role: RoomRole::Creator,
            status: MemberStatus::Active,
            added_permissions: None,    // 创建者拥有所有权限，无需添加
            removed_permissions: None,  // 创建者权限不可移除
            version: 0,
            joined_at: Utc::now(),
            updated_at: Utc::now(),
            ..Default::default()
        })
        .await?;

        Ok(room)
    }
}
```

### 7.3 前端权限管理 UI

```rust
/// 生成前端权限管理界面配置
#[derive(Serialize)]
pub struct PermissionUIConfig {
    pub categories: Vec<PermissionCategory>,
}

#[derive(Serialize)]
pub struct PermissionCategory {
    pub name: String,
    pub description: String,
    pub permissions: Vec<PermissionItem>,
}

#[derive(Serialize)]
pub struct PermissionItem {
    pub key: String,
    pub label: String,
    pub description: String,
    pub bit: u64,
    pub enabled: bool,
}

pub fn generate_permission_ui(current_permissions: u64) -> PermissionUIConfig {
    PermissionUIConfig {
        categories: vec![
            PermissionCategory {
                name: "内容管理".to_string(),
                description: "电影和播放列表相关权限".to_string(),
                permissions: vec![
                    PermissionItem {
                        key: "add_movie".to_string(),
                        label: "添加电影".to_string(),
                        description: "允许添加电影到播放列表".to_string(),
                        bit: Permissions::ADD_MOVIE,
                        enabled: (current_permissions & Permissions::ADD_MOVIE) != 0,
                    },
                    PermissionItem {
                        key: "delete_movie_self".to_string(),
                        label: "删除自己的电影".to_string(),
                        description: "允许删除自己添加的电影".to_string(),
                        bit: Permissions::DELETE_MOVIE_SELF,
                        enabled: (current_permissions & Permissions::DELETE_MOVIE_SELF) != 0,
                    },
                    // ... 更多权限
                ],
            },
            PermissionCategory {
                name: "播放控制".to_string(),
                description: "视频播放相关权限".to_string(),
                permissions: vec![
                    PermissionItem {
                        key: "play_control".to_string(),
                        label: "播放控制".to_string(),
                        description: "允许播放、暂停、跳转视频".to_string(),
                        bit: Permissions::PLAY_CONTROL,
                        enabled: (current_permissions & Permissions::PLAY_CONTROL) != 0,
                    },
                    // ... 更多权限
                ],
            },
            // ... 更多分类
        ],
    }
}
```

### 7.4 权限检查缓存

```rust
/// 权限上下文 (缓存权限检查结果)
pub struct PermissionContext {
    user_id: Uuid,
    room_id: String,
    role: RoomRole,
    status: MemberStatus,
    effective_permissions: u64,
}

impl PermissionContext {
    /// 从请求中创建权限上下文 (查询一次数据库)
    pub async fn from_request(
        user_id: Uuid,
        room_id: String,
        room: &Room,
    ) -> Result<Self> {
        let member = room.get_member(user_id).await.ok_or(Error::NotRoomMember)?;

        Ok(Self {
            user_id,
            room_id,
            role: member.role,
            status: member.status,
            effective_permissions: member.effective_permissions(room).0,
        })
    }

    /// 检查权限 (无需数据库查询)
    pub fn has_permission(&self, permission: u64) -> bool {
        if self.status != MemberStatus::Active {
            return false;
        }

        (self.effective_permissions & permission) != 0
    }
}

// 使用示例
pub async fn handler(
    Extension(user): Extension<User>,
    Extension(room): Extension<Room>,
) -> Result<StatusCode> {
    // 创建权限上下文 (查询一次)
    let perm_ctx = PermissionContext::from_request(user.id, room.id.clone(), &room).await?;

    // 多次权限检查 (无需额外查询)
    if !perm_ctx.has_permission(Permissions::ADD_MOVIE) {
        return Err(Error::PermissionDenied.into());
    }

    if !perm_ctx.has_permission(Permissions::SEND_CHAT) {
        return Err(Error::PermissionDenied.into());
    }

    // 业务逻辑...
    Ok(StatusCode::OK)
}
```

---

## 8. Allow/Deny 权限模式设计理由

### 8.1 为什么采用 Allow/Deny 模式

本系统采用 **Allow/Deny 增量权限模式**（类似Discord/AWS IAM），而不是传统的完全覆盖模式。

#### 核心原理

```rust
// 权限计算公式
effective_permissions = (role_default | added_permissions) & ~removed_permissions
```

- `role_default`: 角色基础权限（从房间配置或全局默认继承）
- `added_permissions`: 额外添加的权限
- `removed_permissions`: 移除的权限

#### 关键优势

**1. 新增权限自动生效**

```rust
// 场景：Bob被禁止聊天
let bob = RoomMember {
    role: RoomRole::Member,
    removed_permissions: Some(Permissions::SEND_CHAT),
    ..
};

// 系统升级，新增 VIEW_STATS 权限到 DEFAULT_MEMBER
// ✅ Bob自动获得新权限（从角色默认继承）
// ✅ 禁止聊天的设置仍然保留
```

**2. 符合直觉**

用户期望：

- "给Alice额外添加踢人权限" → `added_permissions = KICK_MEMBER`
- "禁止Bob聊天" → `removed_permissions = SEND_CHAT`
- 其他权限保持默认，跟随角色更新

**3. 运维友好**

管理员可以：

- 调整角色默认权限，所有成员自动继承
- 个别成员的自定义修改不受影响
- 无需手动为每个用户重新配置

### 8.2 与完全覆盖模式对比

| 特性 | Allow/Deny模式 | 完全覆盖模式 |
|------|---------------|-------------|
| 新增权限 | ✅ 自动生效 | ❌ 需手动迁移 |
| 个性化设置 | ✅ 保留 | ✅ 保留 |
| 运维成本 | ✅ 低 | ❌ 高 |
| 实现复杂度 | 中等（2个字段） | 低（1个字段） |
| 生产验证 | ✅ Discord, AWS IAM | - |

### 8.3 实际应用场景

#### 场景1：移除权限

```rust
// Bob是Member，禁止聊天但保留其他默认权限
removed_permissions = SEND_CHAT

// 结果：有添加电影、查看列表等权限，但不能聊天
```

#### 场景2：添加权限

```rust
// Alice是Member，额外给予管理员能力
added_permissions = KICK_MEMBER | BAN_MEMBER

// 结果：拥有全部Member权限 + 踢人 + 封禁
```

#### 场景3：重置为默认

```rust
// Charlie想恢复默认权限
added_permissions = None
removed_permissions = None

// 结果：使用角色默认权限，跟随角色设置变化
```

### 8.4 API 设计

```rust
#[derive(Deserialize)]
pub struct UpdateMemberPermissionsRequest {
    /// 要添加的权限名称列表
    pub add_permissions: Vec<String>,     // ["KICK_MEMBER"]

    /// 要移除的权限名称列表
    pub remove_permissions: Vec<String>,  // ["SEND_CHAT"]

    /// 是否重置为角色默认
    #[serde(default)]
    pub reset_to_default: bool,
}
```

### 8.5 总结

**设计选择**：采用 Allow/Deny 模式作为**唯一实现**

**核心价值**：

- ✅ 新增权限自动生效，降低运维成本
- ✅ 符合用户直觉，易于理解和使用
- ✅ 生产验证，大型系统采用的成熟方案
- ✅ 灵活性高，支持复杂的权限定制需求

---

## 总结

本章节设计了一个**清晰、灵活、安全**的权限系统:

✅ **角色与状态分离**: Role 和 Status 是独立的概念,避免混淆
✅ **清晰的权限继承**: Creator → Custom → Role Default → Global Default
✅ **细粒度控制**: 64 位权限位掩码支持复杂场景
✅ **灵活配置**: 支持房间默认权限和个人自定义权限
✅ **安全第一**: 默认最小权限,早期权限检查
✅ **易于理解**: 类似 Telegram 的直观权限模型
✅ **多副本友好**: 权限数据存储在数据库,跨副本一致
✅ **向前兼容**: Allow/Deny模式保证新增权限自动生效

关键改进:

- ❌ 移除了 UserRole 中的 Pending 和 Banned (现在是独立的 UserStatus)
- ✅ 新增了 RoomMemberStatus 与 RoomRole 的分离
- ✅ 明确了权限继承链: Creator → Custom → Role Default → Global Default
- ✅ 自定义权限使用 Option<u64>, None 表示使用默认权限
- ✅ 房间设置包含 default_member_permissions 和 default_admin_permissions
- ✅ 所有权限检查都先检查 status,再检查 permissions

**核心特性**:

- ✅ **Allow/Deny模式**: 采用增量权限修改（详见§8）
  - `added_permissions`: 额外添加的权限
  - `removed_permissions`: 移除的权限
  - 最终权限 = `(base | added) & ~removed`
- ✅ **新增权限自动生效**: 用户自动继承角色默认的新权限
- ✅ **个性化设置保留**: 自定义修改不影响权限更新
- ✅ **生产验证**: Discord、AWS IAM等大型系统采用的成熟方案

**上一章**: [06-用户系统设计](./06-用户系统设计.md)
**下一章**: [08-视频内容管理](./19-配置管理系统.md)
