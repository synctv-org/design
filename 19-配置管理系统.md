# 19. é…ç½®ç®¡ç†ç³»ç»Ÿ

---

## ç›®å½•

- [1. è®¾è®¡ç†å¿µ](#1-è®¾è®¡ç†å¿µ)
- [2. é™æ€é…ç½®åŠ è½½](#2-é™æ€é…ç½®åŠ è½½)
- [3. é…ç½®æ–‡ä»¶æ ¼å¼](#3-é…ç½®æ–‡ä»¶æ ¼å¼)
- [4. ç¯å¢ƒå˜é‡æ˜ å°„](#4-ç¯å¢ƒå˜é‡æ˜ å°„)
- [5. CLI å‚æ•°è®¾è®¡](#5-cli-å‚æ•°è®¾è®¡)
- [6. åŠ¨æ€é…ç½®ç³»ç»Ÿï¼ˆdb_settingsï¼‰](#6-åŠ¨æ€é…ç½®ç³»ç»Ÿdb_settings)
- [7. é…ç½®åˆ†ç»„](#7-é…ç½®åˆ†ç»„)
- [8. å®ç°æ–¹æ¡ˆ](#8-å®ç°æ–¹æ¡ˆ)

---

## 1. è®¾è®¡ç†å¿µ

### 1.1 æ ¸å¿ƒåŸåˆ™

SyncTV ä½¿ç”¨ **åŒå±‚é…ç½®ç³»ç»Ÿ**ï¼Œä¸¥æ ¼åŒºåˆ†é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®ï¼š

| é…ç½®ç±»å‹ | æ¥æº | å˜æ›´æ–¹å¼ | ç”Ÿæ•ˆæ–¹å¼ | ç”¨é€” |
|---------|------|---------|---------|------|
| **é™æ€é…ç½®** | CLI/ENV/File | ä¿®æ”¹æ–‡ä»¶/ç¯å¢ƒå˜é‡ | **éœ€è¦é‡å¯** | åŸºç¡€è®¾æ–½é…ç½® |
| **åŠ¨æ€é…ç½®** | Database (settingsè¡¨) | Web UI / CLI å‘½ä»¤ | **å®æ—¶ç”Ÿæ•ˆ** | ä¸šåŠ¡è§„åˆ™é…ç½® |

**å…³é”®åŒºåˆ«**ï¼š

- âŒ **é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®æ²¡æœ‰ä¼˜å…ˆçº§å…³ç³»**
- âœ… å®ƒä»¬æ˜¯ä¸¤ä¸ª**ç‹¬ç«‹çš„é…ç½®ç³»ç»Ÿ**ï¼Œç®¡ç†ä¸åŒç±»å‹çš„é…ç½®é¡¹
- âœ… é™æ€é…ç½®ç”¨äºåŸºç¡€è®¾æ–½ï¼ˆæ•°æ®åº“ã€Redisã€ç«¯å£ç­‰ï¼‰
- âœ… åŠ¨æ€é…ç½®ç”¨äºä¸šåŠ¡è§„åˆ™ï¼ˆæˆ¿é—´é™åˆ¶ã€ç”¨æˆ·æƒé™ç­‰ï¼‰

### 1.2 é™æ€é…ç½®æ¶æ„

**ç”¨é€”**: æœåŠ¡å™¨å¯åŠ¨å‚æ•°ã€åŸºç¡€è®¾æ–½è¿æ¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CLI å‚æ•° (æœ€é«˜ä¼˜å…ˆçº§)                       â”‚
â”‚  --database-url postgres://...                       â”‚
â”‚  --redis-url redis://...                             â”‚
â”‚  --port 8080                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¯å¢ƒå˜é‡                                 â”‚
â”‚  SYNCTV_DATABASE_URL=postgres://...                  â”‚
â”‚  SYNCTV_REDIS_URL=redis://...                        â”‚
â”‚  SYNCTV_SERVER_PORT=8080                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é…ç½®æ–‡ä»¶ (config.yaml)                     â”‚
â”‚  database:                                           â”‚
â”‚    url: "postgres://..."                             â”‚
â”‚  server:                                             â”‚
â”‚    port: 8080                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é»˜è®¤å€¼ (ä»£ç ä¸­å®šä¹‰)                        â”‚
â”‚  const DEFAULT_PORT: u16 = 8080;                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜å…ˆçº§: CLI > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
ç”Ÿæ•ˆæ–¹å¼: å¯åŠ¨æ—¶åŠ è½½ï¼Œä¿®æ”¹åéœ€è¦é‡å¯
```

### 1.3 åŠ¨æ€é…ç½®æ¶æ„

**ç”¨é€”**: ä¸šåŠ¡è§„åˆ™ã€åŠŸèƒ½å¼€å…³ã€è¿è¥é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Web UI / CLI å‘½ä»¤                        â”‚
â”‚  synctv setting set room.max_members 50              â”‚
â”‚  UI: Settings -> Room -> Max Members = 50           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL (settings è¡¨)                      â”‚
â”‚  key: room.max_members                               â”‚
â”‚  value: "50"                                         â”‚
â”‚  updated_at: 2024-01-30 10:30:00                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PostgreSQL LISTEN/NOTIFY (å®æ—¶åŒæ­¥)              â”‚
â”‚  NOTIFY settings_changed, 'room.max_members'         â”‚
â”‚  (æ•°æ®åº“è§¦å‘å™¨è‡ªåŠ¨è§¦å‘)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ‰€æœ‰å‰¯æœ¬ (å†…å­˜ç¼“å­˜)                            â”‚
â”‚  DashMap<String, String>                             â”‚
â”‚  å®æ—¶æ›´æ–°ï¼Œæ— éœ€é‡å¯                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”Ÿæ•ˆæ–¹å¼: ä¿®æ”¹åç«‹å³åŒæ­¥åˆ°æ‰€æœ‰å‰¯æœ¬ï¼Œæ— éœ€é‡å¯
```

---

## 2. é™æ€é…ç½®åŠ è½½

### 2.1 é…ç½®åˆ†ç±»

**é™æ€é…ç½®é¡¹**ï¼ˆå¯åŠ¨æ—¶åŠ è½½ï¼Œéœ€è¦é‡å¯ï¼‰ï¼š

| åˆ†ç±» | é…ç½®é¡¹ç¤ºä¾‹ | è¯´æ˜ |
|-----|----------|------|
| **æœåŠ¡å™¨** | host, port, external_url | æœåŠ¡å™¨ç›‘å¬åœ°å€ã€ç«¯å£ |
| **æ•°æ®åº“** | database_url, max_connections | PostgreSQL è¿æ¥é…ç½® |
| **Redis** | redis_url, cluster_urls | Redis è¿æ¥é…ç½® |
| **TLS** | cert_path, key_path | TLS è¯ä¹¦é…ç½® |
| **OAuth2** | client_id, client_secret | OAuth2 å®¢æˆ·ç«¯å‡­è¯ |
| **é‚®ä»¶** | smtp_host, smtp_username, smtp_password | SMTP æœåŠ¡å™¨é…ç½® |
| **RTMP** | rtmp_port | RTMP æœåŠ¡ç«¯å£ |
| **æ—¥å¿—** | log_level, log_format | æ—¥å¿—é…ç½® |

**åŠ¨æ€é…ç½®é¡¹**ï¼ˆè¿è¡Œæ—¶ä¿®æ”¹ï¼Œå®æ—¶ç”Ÿæ•ˆï¼‰ï¼š

| åˆ†ç±» | é…ç½®é¡¹ç¤ºä¾‹ | è¯´æ˜ |
|-----|----------|------|
| **æˆ¿é—´** | max_members, require_approval | æˆ¿é—´åˆ›å»ºè§„åˆ™ |
| **ç”¨æˆ·** | disable_signup, max_room_count | ç”¨æˆ·æ³¨å†Œè§„åˆ™ |
| **åŠŸèƒ½** | enable_guest, enable_webrtc | åŠŸèƒ½å¼€å…³ |
| **é™æµ** | rate_limit_per_user | é™æµé…ç½® |
| **ä»£ç†** | enable_movie_proxy | ä»£ç†å¼€å…³ |

### 2.2 é™æ€é…ç½®ä¼˜å…ˆçº§

```rust
pub enum StaticConfigSource {
    /// CLI å‚æ•° (ä¼˜å…ˆçº§: 1 - æœ€é«˜)
    Cli,
    /// ç¯å¢ƒå˜é‡ (ä¼˜å…ˆçº§: 2)
    Env,
    /// é…ç½®æ–‡ä»¶ (ä¼˜å…ˆçº§: 3)
    File,
    /// é»˜è®¤å€¼ (ä¼˜å…ˆçº§: 4 - æœ€ä½)
    Default,
}

/// é…ç½®å€¼çš„æ¥æºè¿½è¸ª (ç”¨äºè°ƒè¯•)
pub struct StaticConfigValue<T> {
    pub value: T,
    pub source: StaticConfigSource,
}

impl<T> StaticConfigValue<T> {
    /// åˆå¹¶å¤šä¸ªé™æ€é…ç½®æº,ä¼˜å…ˆçº§é«˜çš„è¦†ç›–ä¼˜å…ˆçº§ä½çš„
    pub fn merge(sources: Vec<(StaticConfigSource, Option<T>)>) -> Option<Self> {
        sources
            .into_iter()
            .filter_map(|(source, value)| value.map(|v| (source, v)))
            .min_by_key(|(source, _)| *source as u8)
            .map(|(source, value)| Self { value, source })
    }
}
```

### 2.3 é™æ€é…ç½®åŠ è½½æµç¨‹

```rust
pub struct StaticConfigLoader {
    cli_args: CliArgs,
    env_vars: HashMap<String, String>,
    file_config: Option<FileConfig>,
}

impl StaticConfigLoader {
    /// åŠ è½½é™æ€é…ç½®ï¼ˆåŸºç¡€è®¾æ–½é…ç½®ï¼‰
    pub async fn load() -> Result<StaticConfig> {
        let loader = Self {
            cli_args: parse_cli_args(),
            env_vars: load_env_vars(),
            file_config: load_file_config()?,
        };

        // æ„å»ºé™æ€é…ç½® (CLI + Env + File + Default)
        let config = loader.build_config()?;

        // éªŒè¯é…ç½®
        config.validate()?;

        Ok(config)
    }

    fn build_config(&self) -> Result<StaticConfig> {
        StaticConfig {
            server: self.load_server_config()?,
            database: self.load_database_config()?,
            redis: self.load_redis_config()?,
            oauth2: self.load_oauth2_config()?,
            email: self.load_email_config()?,
            rtmp: self.load_rtmp_config()?,
            logging: self.load_logging_config()?,
        }
    }

    fn load_server_config(&self) -> Result<ServerConfig> {
        Ok(ServerConfig {
            host: StaticConfigValue::merge(vec![
                (StaticConfigSource::Cli, self.cli_args.host.clone()),
                (StaticConfigSource::Env, self.env_vars.get("SERVER_HOST").cloned()),
                (StaticConfigSource::File, self.file_config.as_ref()
                    .and_then(|f| f.server.host.clone())),
                (StaticConfigSource::Default, Some("0.0.0.0".to_string())),
            ])
            .expect("default value should exist"),

            port: StaticConfigValue::merge(vec![
                (StaticConfigSource::Cli, self.cli_args.port),
                (StaticConfigSource::Env, self.env_vars.get("SERVER_PORT")
                    .and_then(|s| s.parse().ok())),
                (StaticConfigSource::File, self.file_config.as_ref()
                    .and_then(|f| f.server.port)),
                (StaticConfigSource::Default, Some(8080)),
            ])
            .expect("default value should exist"),

            // ...
        })
    }
}
```

---

## 3. é…ç½®æ–‡ä»¶æ ¼å¼

### 3.1 YAML æ ¼å¼

**config.yaml**:

```yaml
server:
  host: "0.0.0.0"
  port: 8080
  external_url: "https://synctv.example.com"
  tls:
    enabled: false
    cert_path: "/path/to/cert.pem"
    key_path: "/path/to/key.pem"

database:
  url: "postgres://synctv:password@localhost:5432/synctv"
  max_connections: 20
  min_connections: 5
  connect_timeout: 30
  idle_timeout: 600

redis:
  url: "redis://localhost:6379"
  max_connections: 10
  connect_timeout: 5

oauth2:
  github:
    enabled: true
    client_id: "your-github-client-id"
    client_secret: "your-github-client-secret"
  google:
    enabled: true
    client_id: "your-google-client-id"
    client_secret: "your-google-client-secret"

email:
  enabled: true
  smtp_host: "smtp.gmail.com"
  smtp_port: 587
  smtp_username: "your-email@gmail.com"
  smtp_password: "your-app-password"
  smtp_tls: true
  from_address: "noreply@synctv.example.com"
  from_name: "SyncTV"
  whitelist:
    enabled: false
    domains:
      - "example.com"
      - "company.com"

rtmp:
  enabled: true
  port: 1935
  max_bitrate: 6000

logging:
  level: "info"
  format: "json"
  output: "stdout"

features:
  enable_guest: true
  enable_room_password: true
  enable_webrtc: true
  enable_live_stream: true
```

---

## 4. ç¯å¢ƒå˜é‡æ˜ å°„

### 4.1 å‘½åè§„èŒƒ

**è§„åˆ™**: `{PREFIX}_{SECTION}_{KEY}` (å…¨éƒ¨å¤§å†™,ä¸‹åˆ’çº¿åˆ†éš”)

**ç¤ºä¾‹**:

```bash
# æœåŠ¡å™¨é…ç½®
SYNCTV_SERVER_HOST=0.0.0.0
SYNCTV_SERVER_PORT=8080
SYNCTV_SERVER_EXTERNAL_URL=https://synctv.example.com

# æ•°æ®åº“é…ç½®
SYNCTV_DATABASE_URL=postgres://synctv:password@localhost:5432/synctv
SYNCTV_DATABASE_MAX_CONNECTIONS=20

# Redisé…ç½®
SYNCTV_REDIS_URL=redis://localhost:6379

# OAuth2é…ç½®
SYNCTV_OAUTH2_GITHUB_ENABLED=true
SYNCTV_OAUTH2_GITHUB_CLIENT_ID=xxx
SYNCTV_OAUTH2_GITHUB_CLIENT_SECRET=yyy

# é‚®ä»¶é…ç½®
SYNCTV_EMAIL_ENABLED=true
SYNCTV_EMAIL_SMTP_HOST=smtp.gmail.com
SYNCTV_EMAIL_SMTP_PORT=587
SYNCTV_EMAIL_SMTP_USERNAME=your-email@gmail.com
SYNCTV_EMAIL_SMTP_PASSWORD=your-app-password

# RTMPé…ç½®
SYNCTV_RTMP_ENABLED=true
SYNCTV_RTMP_PORT=1935

# æ—¥å¿—é…ç½®
SYNCTV_LOGGING_LEVEL=info
SYNCTV_LOGGING_FORMAT=json

# åŠŸèƒ½å¼€å…³
SYNCTV_FEATURES_ENABLE_GUEST=true
SYNCTV_FEATURES_ENABLE_WEBRTC=true
```

### 4.2 ç¯å¢ƒå˜é‡è§£æ

```rust
use std::env;

pub struct EnvLoader {
    prefix: String,
}

impl EnvLoader {
    pub fn new(prefix: &str) -> Self {
        Self {
            prefix: prefix.to_uppercase(),
        }
    }

    pub fn load(&self) -> HashMap<String, String> {
        env::vars()
            .filter(|(key, _)| key.starts_with(&format!("{}_", self.prefix)))
            .map(|(key, value)| {
                // ç§»é™¤å‰ç¼€: SYNCTV_SERVER_HOST -> SERVER_HOST
                let key_without_prefix = key
                    .strip_prefix(&format!("{}_", self.prefix))
                    .unwrap()
                    .to_string();
                (key_without_prefix, value)
            })
            .collect()
    }

    /// å°†ç¯å¢ƒå˜é‡æ˜ å°„åˆ°é…ç½®ç»“æ„
    pub fn get<T: FromStr>(&self, key: &str) -> Option<T> {
        let env_key = format!("{}_{}", self.prefix, key.to_uppercase());
        env::var(&env_key).ok().and_then(|v| v.parse().ok())
    }

    /// è·å–åµŒå¥—é…ç½®: SERVER.HOST -> SERVER_HOST
    pub fn get_nested<T: FromStr>(&self, section: &str, key: &str) -> Option<T> {
        let env_key = format!(
            "{}_{}_{}",
            self.prefix,
            section.to_uppercase(),
            key.to_uppercase()
        );
        env::var(&env_key).ok().and_then(|v| v.parse().ok())
    }
}
```

### 4.3 Docker ç¯å¢ƒå˜é‡ç¤ºä¾‹

```dockerfile
# Dockerfile
FROM rust:1.75 AS builder
# ...

FROM debian:bookworm-slim
WORKDIR /app
COPY --from=builder /app/target/release/synctv .

# è®¾ç½®é»˜è®¤ç¯å¢ƒå˜é‡
ENV SYNCTV_SERVER_HOST=0.0.0.0 \
    SYNCTV_SERVER_PORT=8080 \
    SYNCTV_LOGGING_LEVEL=info \
    SYNCTV_FEATURES_ENABLE_GUEST=true

EXPOSE 8080

CMD ["./synctv", "server"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  synctv:
    image: synctv/synctv:latest
    environment:
      # æ•°æ®åº“é…ç½®
      SYNCTV_DATABASE_URL: postgres://synctv:${DB_PASSWORD}@postgres:5432/synctv
      SYNCTV_REDIS_URL: redis://redis:6379

      # OAuth2é…ç½®
      SYNCTV_OAUTH2_GITHUB_ENABLED: "true"
      SYNCTV_OAUTH2_GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      SYNCTV_OAUTH2_GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}

      # é‚®ä»¶é…ç½®
      SYNCTV_EMAIL_ENABLED: "true"
      SYNCTV_EMAIL_SMTP_HOST: smtp.gmail.com
      SYNCTV_EMAIL_SMTP_PORT: "587"
      SYNCTV_EMAIL_SMTP_USERNAME: ${EMAIL_USERNAME}
      SYNCTV_EMAIL_SMTP_PASSWORD: ${EMAIL_PASSWORD}

      # åŠŸèƒ½å¼€å…³
      SYNCTV_FEATURES_ENABLE_GUEST: "true"
      SYNCTV_FEATURES_ENABLE_WEBRTC: "true"
```

---

## 5. CLI å‚æ•°è®¾è®¡

### 5.1 å…¨å±€å‚æ•°

```bash
synctv [OPTIONS] <COMMAND>

OPTIONS:
  -c, --config <FILE>          é…ç½®æ–‡ä»¶è·¯å¾„ [default: config.yaml]
      --skip-config            è·³è¿‡é…ç½®æ–‡ä»¶åŠ è½½
      --skip-env               è·³è¿‡ç¯å¢ƒå˜é‡åŠ è½½
  -d, --data-dir <PATH>        æ•°æ®ç›®å½• [default: ./data]
      --log-level <LEVEL>      æ—¥å¿—çº§åˆ« [debug|info|warn|error]
      --log-format <FORMAT>    æ—¥å¿—æ ¼å¼ [json|pretty]
  -h, --help                   æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -V, --version                æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

### 5.2 server å­å‘½ä»¤

```bash
synctv server [OPTIONS]

å¯åŠ¨ SyncTV æœåŠ¡å™¨

OPTIONS:
      --host <HOST>                 ç›‘å¬åœ°å€ [default: 0.0.0.0]
  -p, --port <PORT>                 ç›‘å¬ç«¯å£ [default: 8080]
      --database-url <URL>          PostgreSQLè¿æ¥URL
      --redis-url <URL>             Redisè¿æ¥URL
      --external-url <URL>          å¤–éƒ¨è®¿é—®URL (ç”¨äºOAuth2å›è°ƒ)
      --disable-web                 ç¦ç”¨Webç•Œé¢
      --web-path <PATH>             Webé™æ€æ–‡ä»¶è·¯å¾„
      --rtmp-port <PORT>            RTMPç›‘å¬ç«¯å£ [default: 1935]
      --disable-rtmp                ç¦ç”¨RTMPæœåŠ¡
      --force-migrate               å¼ºåˆ¶æ‰§è¡Œæ•°æ®åº“è¿ç§»
  -h, --help                        æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

EXAMPLES:
  # ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
  synctv server --config config.yaml

  # ä½¿ç”¨CLIå‚æ•°è¦†ç›–é…ç½®
  synctv server --port 3000 --database-url postgres://...

  # è·³è¿‡é…ç½®æ–‡ä»¶,ä»…ä½¿ç”¨CLIå‚æ•°å’Œç¯å¢ƒå˜é‡
  synctv server --skip-config --port 3000
```

### 5.3 Clap v4 å®ç°

```rust
use clap::{Parser, Subcommand};

#[derive(Parser)]
#[command(name = "synctv")]
#[command(version, about, long_about = None)]
pub struct Cli {
    /// é…ç½®æ–‡ä»¶è·¯å¾„
    #[arg(short, long, value_name = "FILE", default_value = "config.yaml")]
    pub config: PathBuf,

    /// è·³è¿‡é…ç½®æ–‡ä»¶åŠ è½½
    #[arg(long)]
    pub skip_config: bool,

    /// è·³è¿‡ç¯å¢ƒå˜é‡åŠ è½½
    #[arg(long)]
    pub skip_env: bool,

    /// æ•°æ®ç›®å½•
    #[arg(short, long, value_name = "PATH", default_value = "./data")]
    pub data_dir: PathBuf,

    /// æ—¥å¿—çº§åˆ«
    #[arg(long, value_name = "LEVEL", value_parser = ["trace", "debug", "info", "warn", "error"])]
    pub log_level: Option<String>,

    /// æ—¥å¿—æ ¼å¼
    #[arg(long, value_name = "FORMAT", value_parser = ["json", "pretty"])]
    pub log_format: Option<String>,

    #[command(subcommand)]
    pub command: Commands,
}

#[derive(Subcommand)]
pub enum Commands {
    /// å¯åŠ¨æœåŠ¡å™¨
    Server {
        /// ç›‘å¬åœ°å€
        #[arg(long, default_value = "0.0.0.0")]
        host: String,

        /// ç›‘å¬ç«¯å£
        #[arg(short, long, default_value_t = 8080)]
        port: u16,

        /// PostgreSQLè¿æ¥URL
        #[arg(long)]
        database_url: Option<String>,

        /// Redisè¿æ¥URL
        #[arg(long)]
        redis_url: Option<String>,

        /// å¤–éƒ¨è®¿é—®URL
        #[arg(long)]
        external_url: Option<String>,

        /// ç¦ç”¨Webç•Œé¢
        #[arg(long)]
        disable_web: bool,

        /// Webé™æ€æ–‡ä»¶è·¯å¾„
        #[arg(long)]
        web_path: Option<PathBuf>,

        /// RTMPç›‘å¬ç«¯å£
        #[arg(long, default_value_t = 1935)]
        rtmp_port: u16,

        /// ç¦ç”¨RTMPæœåŠ¡
        #[arg(long)]
        disable_rtmp: bool,

        /// å¼ºåˆ¶æ‰§è¡Œæ•°æ®åº“è¿ç§»
        #[arg(long)]
        force_migrate: bool,
    },

    /// ç®¡ç†å‘˜ç®¡ç†
    Admin {
        #[command(subcommand)]
        command: AdminCommands,
    },

    /// Rootç”¨æˆ·ç®¡ç†
    Root {
        #[command(subcommand)]
        command: RootCommands,
    },

    /// ç”¨æˆ·ç®¡ç†
    User {
        #[command(subcommand)]
        command: UserCommands,
    },

    /// è®¾ç½®ç®¡ç†
    Setting {
        #[command(subcommand)]
        command: SettingCommands,
    },
}

#[derive(Subcommand)]
pub enum AdminCommands {
    /// æ·»åŠ ç®¡ç†å‘˜
    Add {
        username: String,
        password: String,
    },
    /// åˆ é™¤ç®¡ç†å‘˜
    Delete {
        username: String,
    },
    /// æ˜¾ç¤ºæ‰€æœ‰ç®¡ç†å‘˜
    Show,
}
```

---

## 6. åŠ¨æ€é…ç½®ç³»ç»Ÿï¼ˆdb_settingsï¼‰

### 6.1 æ ¸å¿ƒç‰¹æ€§

**ä¸é™æ€é…ç½®çš„æ ¹æœ¬åŒºåˆ«**ï¼š

| ç‰¹æ€§ | é™æ€é…ç½® (CLI/ENV/File) | åŠ¨æ€é…ç½® (db_settings) |
|-----|------------------------|----------------------|
| **å­˜å‚¨ä½ç½®** | é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ | PostgreSQL settings è¡¨ |
| **ä¿®æ”¹æ–¹å¼** | ç¼–è¾‘æ–‡ä»¶/ç¯å¢ƒå˜é‡ | ç›´æ¥ SQL / Web UI / CLI |
| **ç”Ÿæ•ˆæ–¹å¼** | **éœ€è¦é‡å¯æœåŠ¡** | **ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯** |
| **å¤šå‰¯æœ¬åŒæ­¥** | æ‰‹åŠ¨åŒæ­¥ | **è‡ªåŠ¨åŒæ­¥ï¼ˆPostgreSQL LISTEN/NOTIFYï¼‰** |
| **é€‚ç”¨åœºæ™¯** | åŸºç¡€è®¾æ–½é…ç½® | ä¸šåŠ¡è§„åˆ™é…ç½® |
| **ç¤ºä¾‹** | æ•°æ®åº“URLã€æœåŠ¡å™¨ç«¯å£ | æˆ¿é—´æ•°é‡é™åˆ¶ã€åŠŸèƒ½å¼€å…³ |

### 6.2 è®¾ç½®è¡¨ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰

```sql
-- é…ç½®è¡¨ï¼ˆåªå­˜å­—ç¬¦ä¸²ï¼Œè§£æåœ¨ä»£ç å±‚ï¼‰
CREATE TABLE settings (
    key VARCHAR(255) PRIMARY KEY,
    value TEXT NOT NULL,              -- ç»Ÿä¸€å­˜å‚¨ä¸ºå­—ç¬¦ä¸²
    category VARCHAR(100) NOT NULL,   -- åˆ†ç±»ï¼ˆroom, user, rate_limit, etc.ï¼‰
    description TEXT,                 -- æè¿°
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_settings_category ON settings(category);

-- è§¦å‘å™¨ï¼šé…ç½®å˜æ›´æ—¶è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰å‰¯æœ¬
CREATE OR REPLACE FUNCTION notify_settings_change()
RETURNS TRIGGER AS $$
BEGIN
    -- INSERT/UPDATE æ—¶é€šçŸ¥æ–°çš„ key
    IF TG_OP = 'INSERT' OR TG_OP = 'UPDATE' THEN
        PERFORM pg_notify('settings_changed', NEW.key);
        RETURN NEW;
    -- DELETE æ—¶ä¹Ÿé€šçŸ¥ï¼ˆè®©å‰¯æœ¬åˆ é™¤ç¼“å­˜ï¼‰
    ELSIF TG_OP = 'DELETE' THEN
        PERFORM pg_notify('settings_changed', OLD.key);
        RETURN OLD;
    END IF;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER settings_change_trigger
    AFTER INSERT OR UPDATE OR DELETE ON settings
    FOR EACH ROW
    EXECUTE FUNCTION notify_settings_change();

-- æ— éœ€é¢„å…ˆæ’å…¥ä»»ä½•æ•°æ®ï¼
-- ä»£ç ä¸­æœ‰é»˜è®¤å€¼ï¼Œæ•°æ®åº“ä¸ºç©ºä¹Ÿèƒ½æ­£å¸¸å·¥ä½œ
```

### 6.3 åŠ¨æ€é…ç½®åŠ è½½ä¸å®æ—¶åŒæ­¥

#### 6.3.1 æ ¸å¿ƒè®¾è®¡ç†å¿µ

**æœ¬è´¨**: é…ç½®ç³»ç»Ÿ = **ç¼“å­˜** + **è§£æå™¨**

- æ•°æ®åº“åªå­˜**å­—ç¬¦ä¸²** (TEXT)
- ä»£ç ä¸­å®šä¹‰**ç±»å‹** + **é»˜è®¤å€¼** + **è§£æå‡½æ•°**
- `get(key)` = ä»ç¼“å­˜è¯»å–å­—ç¬¦ä¸² + è§£æä¸ºå¯¹åº”ç±»å‹
- æ•°æ®åº“å˜æ›´é€šè¿‡ **PostgreSQL LISTEN/NOTIFY** è‡ªåŠ¨åˆ·æ–°ç¼“å­˜

#### 6.3.2 é…ç½®é¡¹å®šä¹‰å®

```rust
use std::marker::PhantomData;
use std::str::FromStr;
use once_cell::sync::Lazy;
use std::sync::Mutex;

/// é…ç½®é”®ï¼ˆç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶æ£€æŸ¥ï¼‰
pub struct SettingKey<T> {
    pub key: &'static str,
    pub default_value: &'static str,  // é»˜è®¤å€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²
    pub category: &'static str,
    pub description: &'static str,
    _marker: PhantomData<T>,
}

impl<T> SettingKey<T> {
    pub const fn new(
        key: &'static str,
        default_value: &'static str,
        category: &'static str,
        description: &'static str,
    ) -> Self {
        Self {
            key,
            default_value,
            category,
            description,
            _marker: PhantomData,
        }
    }
}

/// é…ç½®å®šä¹‰ï¼ˆç”¨äºåˆå§‹åŒ–æ•°æ®åº“ï¼‰
pub struct SettingDefinition {
    pub key: &'static str,
    pub default_value: &'static str,
    pub category: &'static str,
    pub description: &'static str,
}

/// å…¨å±€é…ç½®å®šä¹‰æ³¨å†Œè¡¨
static SETTING_DEFINITIONS: Lazy<Mutex<Vec<SettingDefinition>>> = Lazy::new(|| {
    Mutex::new(Vec::new())
});

/// é…ç½®å®šä¹‰å®ï¼ˆç®€åŒ–é…ç½®é¡¹å£°æ˜ + è‡ªåŠ¨æ³¨å†Œï¼‰
#[macro_export]
macro_rules! setting {
    ($name:ident: $ty:ty = $key:expr, $default:expr, $category:expr, $desc:expr) => {
        pub static $name: SettingKey<$ty> = SettingKey::new(
            $key,
            $default,
            $category,
            $desc,
        );

        // è‡ªåŠ¨æ³¨å†Œåˆ°å…¨å±€å®šä¹‰è¡¨
        inventory::submit! {
            SettingDefinition {
                key: $key,
                default_value: $default,
                category: $category,
                description: $desc,
            }
        }
    };
}

// ============================================
// å…¨å±€é…ç½®å®šä¹‰ï¼ˆç¼–è¯‘æ—¶ç±»å‹å®‰å…¨ï¼‰
// ============================================

// æˆ¿é—´é…ç½®
setting!(ROOM_DISABLE_CREATE: bool =
    "room.disable_create",
    "false",
    "room",
    "ç¦ç”¨æˆ¿é—´åˆ›å»º"
);

setting!(ROOM_MAX_MEMBERS: i64 =
    "room.max_members",
    "100",
    "room",
    "æˆ¿é—´æœ€å¤§æˆå‘˜æ•°"
);

setting!(ROOM_TTL_HOURS: i64 =
    "room.ttl_hours",
    "48",
    "room",
    "æˆ¿é—´æ— æ´»åŠ¨è‡ªåŠ¨å…³é—­æ—¶é—´(å°æ—¶)"
);

// ç”¨æˆ·é…ç½®
setting!(USER_DISABLE_SIGNUP: bool =
    "user.disable_signup",
    "false",
    "user",
    "ç¦ç”¨ç”¨æˆ·æ³¨å†Œ"
);

setting!(USER_MAX_ROOM_COUNT: i64 =
    "user.max_room_count",
    "3",
    "user",
    "æ¯ä¸ªç”¨æˆ·æœ€å¤šåˆ›å»ºæˆ¿é—´æ•°"
);

setting!(USER_ENABLE_GUEST: bool =
    "user.enable_guest",
    "true",
    "user",
    "å¯ç”¨æ¸¸å®¢æ¨¡å¼"
);

// é™æµé…ç½®
setting!(RATE_LIMIT_LOGIN_MAX_REQUESTS: i64 =
    "rate_limit.login.max_requests",
    "5",
    "rate_limit",
    "ç™»å½•ï¼šæ—¶é—´çª—å£å†…æœ€å¤§è¯·æ±‚æ•°"
);

setting!(RATE_LIMIT_LOGIN_WINDOW_SECONDS: i64 =
    "rate_limit.login.window_seconds",
    "60",
    "rate_limit",
    "ç™»å½•ï¼šæ—¶é—´çª—å£ï¼ˆç§’ï¼‰"
);

setting!(RATE_LIMIT_LOGIN_ENABLED: bool =
    "rate_limit.login.enabled",
    "true",
    "rate_limit",
    "ç™»å½•ï¼šæ˜¯å¦å¯ç”¨é™æµ"
);

// ä½¿ç”¨ inventory æ”¶é›†æ‰€æœ‰é…ç½®å®šä¹‰
inventory::collect!(SettingDefinition);
```

#### 6.3.3 é…ç½®ç®¡ç†å™¨ï¼ˆç®€åŒ–ç‰ˆï¼‰

```rust
use dashmap::DashMap;
use sqlx::postgres::{PgListener, PgPool};
use std::sync::Arc;
use std::str::FromStr;

/// åŠ¨æ€é…ç½®ç®¡ç†å™¨ï¼ˆç¼“å­˜ + è§£æå™¨ï¼‰
pub struct DynamicSettings {
    /// å­—ç¬¦ä¸²ç¼“å­˜ï¼ˆä»æ•°æ®åº“åŠ è½½ï¼‰
    cache: Arc<DashMap<String, String>>,
    db_pool: PgPool,
}

impl DynamicSettings {
    /// åˆå§‹åŒ–é…ç½®ç³»ç»Ÿ
    pub async fn init(db_pool: PgPool) -> Result<Self> {
        let settings = Self {
            cache: Arc::new(DashMap::new()),
            db_pool: db_pool.clone(),
        };

        // 1. åŒæ­¥é…ç½®å®šä¹‰åˆ°æ•°æ®åº“ï¼ˆä¸å­˜åœ¨åˆ™æ’å…¥é»˜è®¤å€¼ï¼Œå­˜åœ¨åˆ™ä¿ç•™ï¼‰
        settings.init_definitions().await?;

        // 2. ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰é…ç½®ï¼ˆåªå­˜å­—ç¬¦ä¸²ï¼‰
        settings.load_from_db().await?;

        // 3. å¯åŠ¨ PostgreSQL LISTEN ç›‘å¬é…ç½®å˜æ›´
        settings.start_pg_listener().await?;

        tracing::info!(
            "Dynamic settings initialized with {} keys",
            settings.cache.len()
        );

        Ok(settings)
    }

    /// åŒæ­¥é…ç½®å®šä¹‰åˆ°æ•°æ®åº“
    /// - å¦‚æœé…ç½®ä¸å­˜åœ¨ï¼Œæ’å…¥é»˜è®¤å€¼
    /// - å¦‚æœé…ç½®å·²å­˜åœ¨ï¼Œä¿ç•™ç°æœ‰å€¼ï¼ˆä¸è¦†ç›–ï¼‰
    async fn init_definitions(&self) -> Result<()> {
        tracing::info!("Syncing setting definitions to database...");

        let mut synced_count = 0;
        let mut skipped_count = 0;

        for def in inventory::iter::<SettingDefinition> {
            // ä½¿ç”¨ INSERT ... ON CONFLICT DO NOTHINGï¼ˆä¸è¦†ç›–å·²å­˜åœ¨çš„å€¼ï¼‰
            let result = sqlx::query!(
                r#"
                INSERT INTO settings (key, value, category, description)
                VALUES ($1, $2, $3, $4)
                ON CONFLICT (key) DO NOTHING
                "#,
                def.key,
                def.default_value,
                def.category,
                def.description
            )
            .execute(&self.db_pool)
            .await?;

            if result.rows_affected() > 0 {
                tracing::debug!("Inserted default setting: {} = {}", def.key, def.default_value);
                synced_count += 1;
            } else {
                skipped_count += 1;
            }
        }

        tracing::info!(
            "Setting definitions synced: {} inserted, {} already exist",
            synced_count,
            skipped_count
        );

        Ok(())
    }

    /// ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰é…ç½®
    async fn load_from_db(&self) -> Result<()> {
        let rows = sqlx::query!(
            "SELECT key, value FROM settings"
        )
        .fetch_all(&self.db_pool)
        .await?;

        for row in rows {
            self.cache.insert(row.key, row.value);
        }

        tracing::info!("Loaded {} settings from database", rows.len());
        Ok(())
    }

    /// å¯åŠ¨ PostgreSQL LISTEN ç›‘å¬å™¨ï¼ˆæ›¿ä»£ Redis Pub/Subï¼‰
    async fn start_pg_listener(&self) -> Result<()> {
        let cache = self.cache.clone();
        let db_pool = self.db_pool.clone();

        tokio::spawn(async move {
            let mut listener = PgListener::connect_with(&db_pool)
                .await
                .expect("Failed to create PgListener");

            listener
                .listen("settings_changed")
                .await
                .expect("Failed to listen on channel");

            tracing::info!("PostgreSQL LISTEN started for settings_changed");

            loop {
                match listener.recv().await {
                    Ok(notification) => {
                        let key = notification.payload();
                        tracing::info!("ğŸ”„ Setting changed: {}", key);

                        // ä»æ•°æ®åº“é‡æ–°åŠ è½½è¯¥é…ç½®
                        if let Ok(Some(row)) = sqlx::query!(
                            "SELECT value FROM settings WHERE key = $1",
                            key
                        )
                        .fetch_optional(&db_pool)
                        .await
                        {
                            cache.insert(key.to_string(), row.value);
                            tracing::debug!("âœ… Reloaded setting: {}", key);
                        } else {
                            // é…ç½®å·²åˆ é™¤ï¼Œä»ç¼“å­˜ç§»é™¤
                            cache.remove(key);
                            tracing::debug!("ğŸ—‘ï¸  Removed setting from cache: {}", key);
                        }
                    }
                    Err(e) => {
                        tracing::error!("Error receiving notification: {}", e);
                    }
                }
            }
        });

        Ok(())
    }

    /// è·å–é…ç½®å€¼ï¼ˆæ³›å‹æ–¹æ³•ï¼Œè‡ªåŠ¨è§£æï¼‰
    ///
    /// è¿”å› Result ä»¥ä¾¿è°ƒç”¨è€…æ˜ç¡®å¤„ç†é…ç½®é”™è¯¯
    pub fn get<T>(&self, key: &SettingKey<T>) -> Result<T>
    where
        T: FromStr,
        <T as FromStr>::Err: std::fmt::Display,
    {
        // 1. å°è¯•ä»ç¼“å­˜è¯»å–ï¼ˆæ•°æ®åº“ä¸­çš„å€¼ï¼‰
        if let Some(value_str) = self.cache.get(key.key) {
            return value_str.parse::<T>().map_err(|e| {
                Error::ConfigParseError {
                    key: key.key.to_string(),
                    value: value_str.clone(),
                    error: e.to_string(),
                }
            });
        }

        // 2. ç¼“å­˜ä¸­æ²¡æœ‰ï¼Œè§£æé»˜è®¤å€¼
        key.default_value.parse::<T>().map_err(|e| {
            Error::InvalidDefaultValue {
                key: key.key.to_string(),
                default_value: key.default_value.to_string(),
                error: e.to_string(),
            }
        })
    }

    /// è·å–é…ç½®å€¼æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼ˆä¸è¿”å›é”™è¯¯ï¼‰
    ///
    /// ä¾¿æ·æ–¹æ³•ï¼šå¦‚æœé…ç½®è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼å¹¶è®°å½•è­¦å‘Šæ—¥å¿—
    pub fn get_or_default<T>(&self, key: &SettingKey<T>) -> T
    where
        T: FromStr + Clone,
        <T as FromStr>::Err: std::fmt::Display,
    {
        match self.get(key) {
            Ok(value) => value,
            Err(e) => {
                tracing::warn!(
                    "Failed to get setting '{}': {}, using default value '{}'",
                    key.key,
                    e,
                    key.default_value
                );

                // é»˜è®¤å€¼è§£æä¸€å®šä¼šæˆåŠŸï¼ˆåœ¨ init_definitions æ—¶å·²éªŒè¯ï¼‰
                key.default_value.parse::<T>().unwrap()
            }
        }
    }

    /// è·å–åŠ¨æ€é…ç½®å€¼ï¼ˆç”¨äºè¿è¡Œæ—¶æ„é€ çš„ keyï¼Œå¦‚vendor-specificé…ç½®ï¼‰
    ///
    /// æ³¨æ„ï¼šæ— æ³•äº«å—ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œä»…ç”¨äºå¿…é¡»åŠ¨æ€æ„é€  key çš„åœºæ™¯
    pub fn get_dynamic<T>(&self, key: &str, default_value: &str) -> Result<T>
    where
        T: FromStr,
        <T as FromStr>::Err: std::fmt::Display,
    {
        if let Some(value_str) = self.cache.get(key) {
            return value_str.parse::<T>().map_err(|e| {
                Error::ConfigParseError {
                    key: key.to_string(),
                    value: value_str.clone(),
                    error: e.to_string(),
                }
            });
        }

        default_value.parse::<T>().map_err(|e| {
            Error::InvalidDefaultValue {
                key: key.to_string(),
                default_value: default_value.to_string(),
                error: e.to_string(),
            }
        })
    }
}

/// é…ç½®é”™è¯¯ç±»å‹
#[derive(Debug, thiserror::Error)]
pub enum Error {
    #[error("Failed to parse config '{key}' value '{value}': {error}")]
    ConfigParseError {
        key: String,
        value: String,
        error: String,
    },

    #[error("Invalid default value for config '{key}': '{default_value}' - {error}")]
    InvalidDefaultValue {
        key: String,
        default_value: String,
        error: String,
    },

    #[error("Database error: {0}")]
    Database(#[from] sqlx::Error),
}
```

#### 6.3.4 ç›´æ¥åœ¨æ•°æ®åº“ä¿®æ”¹é…ç½®ï¼ˆæ— éœ€ä»£ç å±‚ set æ–¹æ³•ï¼‰

```sql
-- ============================================
-- æ–¹å¼ 1: SQL ç›´æ¥ä¿®æ”¹ï¼ˆæ¨èï¼Œç®€å•ç›´æ¥ï¼‰
-- ============================================

-- é¦–æ¬¡è®¾ç½®ï¼ˆINSERTï¼‰
INSERT INTO settings (key, value, category, description)
VALUES ('room.max_members', '100', 'room', 'æˆ¿é—´æœ€å¤§æˆå‘˜æ•°');
-- â†’ è§¦å‘å™¨è‡ªåŠ¨ NOTIFY 'settings_changed', 'room.max_members'
-- â†’ æ‰€æœ‰å‰¯æœ¬è‡ªåŠ¨é‡æ–°åŠ è½½

-- ä¿®æ”¹é…ç½®ï¼ˆUPDATEï¼‰
UPDATE settings
SET value = '200', updated_at = NOW()
WHERE key = 'room.max_members';
-- â†’ è§¦å‘å™¨è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰å‰¯æœ¬

-- åˆ é™¤é…ç½®ï¼ˆæ¢å¤é»˜è®¤å€¼ï¼‰
DELETE FROM settings WHERE key = 'room.max_members';
-- â†’ è§¦å‘å™¨é€šçŸ¥ï¼Œå‰¯æœ¬åˆ é™¤ç¼“å­˜ï¼Œä¸‹æ¬¡ get è¿”å›é»˜è®¤å€¼

-- UPSERTï¼ˆæ¨èæ–¹å¼ï¼‰
INSERT INTO settings (key, value, category, description)
VALUES ('room.max_members', '150', 'room', 'æˆ¿é—´æœ€å¤§æˆå‘˜æ•°')
ON CONFLICT (key) DO UPDATE
SET value = EXCLUDED.value, updated_at = NOW();

-- ============================================
-- æ–¹å¼ 2: é€šè¿‡ç®¡ç† APIï¼ˆå¯é€‰ï¼‰
-- ============================================

-- POST /api/admin/settings
-- {
--   "key": "room.max_members",
--   "value": "150"
-- }
-- å†…éƒ¨ä¹Ÿæ˜¯æ‰§è¡Œ SQL INSERT/UPDATE
```

### 6.4 ä½¿ç”¨ç¤ºä¾‹

```rust
// ============================================
// ç¤ºä¾‹ 1: åŸºæœ¬ç”¨æ³•ï¼ˆè¿”å› Resultï¼‰
// ============================================

// get() è¿”å› Resultï¼Œæ˜¾å¼é”™è¯¯å¤„ç†
let max_members: i64 = settings.get(&ROOM_MAX_MEMBERS)?;  // è¿”å› Result<i64>
let disable_create: bool = settings.get(&ROOM_DISABLE_CREATE)?;  // è¿”å› Result<bool>

// ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥
let value: i64 = settings.get(&ROOM_MAX_MEMBERS)?;  // âœ… ç¼–è¯‘é€šè¿‡
let value: bool = settings.get(&ROOM_MAX_MEMBERS)?;  // âŒ ç¼–è¯‘é”™è¯¯ï¼ç±»å‹ä¸åŒ¹é…

// ä½¿ç”¨ match å¤„ç†é”™è¯¯
match settings.get(&ROOM_MAX_MEMBERS) {
    Ok(max) => println!("Max members: {}", max),
    Err(e) => {
        tracing::error!("Failed to parse config: {}", e);
        // å†³å®šå¦‚ä½•å¤„ç†ï¼šä½¿ç”¨é»˜è®¤å€¼ã€è¿”å›é”™è¯¯ã€æˆ– panic
    }
}

// ============================================
// ç¤ºä¾‹ 2: ä½¿ç”¨ get_or_default()ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
// ============================================

// å¦‚æœè§£æå¤±è´¥ï¼Œè‡ªåŠ¨ä½¿ç”¨é»˜è®¤å€¼å¹¶è®°å½•è­¦å‘Š
let max_members = settings.get_or_default(&ROOM_MAX_MEMBERS);  // è¿”å› i64
let disable_create = settings.get_or_default(&ROOM_DISABLE_CREATE);  // è¿”å› bool

// é€‚ç”¨åœºæ™¯ï¼šé…ç½®é”™è¯¯ä¸åº”è¯¥é˜»æ­¢æœåŠ¡è¿è¡Œ
// æ—¥å¿—è¾“å‡ºï¼ˆå¦‚æœè§£æå¤±è´¥ï¼‰:
// WARN Failed to get setting 'room.max_members': Failed to parse config
//      'room.max_members' value 'invalid': invalid digit found in string,
//      using default value '100'

// ============================================
// ç¤ºä¾‹ 3: ä¸šåŠ¡ä»£ç ä¸­ä½¿ç”¨
// ============================================

pub async fn create_room(
    settings: &DynamicSettings,
    user: &User,
    name: String,
) -> Result<Room> {
    // æ–¹å¼ 1: ä½¿ç”¨ ? ä¼ æ’­é”™è¯¯ï¼ˆé…ç½®é”™è¯¯ä¼šå¯¼è‡´ API è¿”å› 500ï¼‰
    let disable_create = settings.get(&ROOM_DISABLE_CREATE)?;
    if disable_create {
        return Err(Error::RoomCreationDisabled);
    }

    // æ–¹å¼ 2: ä½¿ç”¨ get_or_defaultï¼ˆé…ç½®é”™è¯¯ä¸é˜»æ­¢ä¸šåŠ¡ï¼‰
    let max_room_count = settings.get_or_default(&USER_MAX_ROOM_COUNT);

    // æ£€æŸ¥ç”¨æˆ·åˆ›å»ºçš„æˆ¿é—´æ•°æ˜¯å¦è¶…é™
    let user_room_count = count_user_rooms(&user.id).await?;
    if user_room_count >= max_room_count {
        return Err(Error::RoomLimitExceeded {
            current: user_room_count,
            max: max_room_count,
        });
    }

    // åˆ›å»ºæˆ¿é—´
    create_room_in_db(name).await
}

// ============================================
// ç¤ºä¾‹ 4: é™æµé…ç½®ï¼ˆæ˜¾å¼é”™è¯¯å¤„ç† vs é™çº§ç­–ç•¥ï¼‰
// ============================================

impl RateLimitService {
    pub async fn check_rate_limit(
        &self,
        ip: IpAddr,
        action: RateLimitAction,
    ) -> Result<()> {
        // æ–¹å¼ 1: ä½¿ç”¨ ? ä¼ æ’­é”™è¯¯ï¼ˆé…ç½®é”™è¯¯å¯¼è‡´é™æµå¤±è´¥ï¼‰
        let max_requests = match action {
            RateLimitAction::Login =>
                self.settings.get(&RATE_LIMIT_LOGIN_MAX_REQUESTS)?,
            // ... å…¶ä»–æ“ä½œ
        };

        let window_seconds = match action {
            RateLimitAction::Login =>
                self.settings.get(&RATE_LIMIT_LOGIN_WINDOW_SECONDS)?,
            // ... å…¶ä»–æ“ä½œ
        };

        // æ–¹å¼ 2: ä½¿ç”¨ get_or_defaultï¼ˆé…ç½®é”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤å€¼ï¼‰
        let enabled = match action {
            RateLimitAction::Login =>
                self.settings.get_or_default(&RATE_LIMIT_LOGIN_ENABLED),
            // ... å…¶ä»–æ“ä½œ
        };

        if !enabled {
            return Ok(());  // é™æµå·²ç¦ç”¨
        }

        // æ‰§è¡Œé™æµæ£€æŸ¥
        let key = format!("ratelimit:{}:{}", ip, action.as_str());
        let count = self.redis_incr(&key).await?;

        if count > max_requests {
            return Err(Error::TooManyAttempts {
                retry_after: window_seconds as u64,
            });
        }

        Ok(())
    }
}

// ============================================
// ç¤ºä¾‹ 5: é”™è¯¯å¤„ç†ç­–ç•¥é€‰æ‹©
// ============================================

// ç­–ç•¥ 1: å¿«é€Ÿå¤±è´¥ï¼ˆé…ç½®é”™è¯¯é˜»æ­¢æœåŠ¡å¯åŠ¨ï¼‰
pub async fn main() -> Result<()> {
    let settings = DynamicSettings::init(db_pool).await?;

    // å¯åŠ¨æ—¶éªŒè¯å…³é”®é…ç½®
    let _max_members = settings.get(&ROOM_MAX_MEMBERS)
        .expect("Failed to parse ROOM_MAX_MEMBERS config");

    // å¦‚æœé…ç½®é”™è¯¯ï¼ŒæœåŠ¡ä¸ä¼šå¯åŠ¨
    start_server(settings).await
}

// ç­–ç•¥ 2: é™çº§ç­–ç•¥ï¼ˆé…ç½®é”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤å€¼ï¼ŒæœåŠ¡ç»§ç»­è¿è¡Œï¼‰
pub async fn handle_request(settings: &DynamicSettings) -> Result<Response> {
    // ä½¿ç”¨ get_or_defaultï¼Œé…ç½®é”™è¯¯åªè®°å½•æ—¥å¿—
    let max_members = settings.get_or_default(&ROOM_MAX_MEMBERS);

    // ä¸šåŠ¡ç»§ç»­æ‰§è¡Œ
    process_with_limit(max_members).await
}

// ç­–ç•¥ 3: æ··åˆç­–ç•¥ï¼ˆå…³é”®é…ç½®å¿«é€Ÿå¤±è´¥ï¼Œéå…³é”®é…ç½®é™çº§ï¼‰
pub async fn create_room(settings: &DynamicSettings) -> Result<Room> {
    // å…³é”®é…ç½®ï¼šé”™è¯¯æ—¶è¿”å›é”™è¯¯
    let disable_create = settings.get(&ROOM_DISABLE_CREATE)?;

    // éå…³é”®é…ç½®ï¼šé”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤å€¼
    let max_members = settings.get_or_default(&ROOM_MAX_MEMBERS);

    // ...
}

// ============================================
// ç¤ºä¾‹ 6: å®Œæ•´çš„åˆå§‹åŒ–ä¸é…ç½®æµç¨‹
// ============================================

// 1. é¦–æ¬¡å¯åŠ¨ï¼ˆæ•°æ®åº“ä¸ºç©ºï¼‰
let settings = DynamicSettings::init(db_pool).await?;
// æ‰§è¡Œæµç¨‹ï¼š
// â‘  init_definitions() - åŒæ­¥æ‰€æœ‰å®šä¹‰çš„é…ç½®åˆ°æ•°æ®åº“
//    â†’ æ‰«ææ‰€æœ‰ setting! å®å®šä¹‰çš„é…ç½®
//    â†’ å¯¹æ¯ä¸ªé…ç½®æ‰§è¡Œ INSERT ... ON CONFLICT DO NOTHING
//    â†’ ä¸å­˜åœ¨åˆ™æ’å…¥é»˜è®¤å€¼ï¼Œå­˜åœ¨åˆ™è·³è¿‡ï¼ˆä¿ç•™è‡ªå®šä¹‰å€¼ï¼‰
//    ç¤ºä¾‹æ—¥å¿—:
//      Inserted default setting: room.max_members = 100
//      Inserted default setting: user.disable_signup = false
//      ...
//
// â‘¡ load_from_db() - ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰é…ç½®åˆ°ç¼“å­˜
//    â†’ SELECT key, value FROM settings
//    â†’ å­˜å…¥ DashMap<String, String> ç¼“å­˜
//
// â‘¢ start_pg_listener() - å¯åŠ¨é…ç½®å˜æ›´ç›‘å¬
//    â†’ LISTEN settings_changed
//    â†’ åå°ä»»åŠ¡æŒç»­ç›‘å¬æ•°æ®åº“é€šçŸ¥

// 2. è¯»å–é…ç½®ï¼ˆé¦–æ¬¡å¯åŠ¨æ—¶ä½¿ç”¨é»˜è®¤å€¼ï¼‰
let max_members = settings.get(&ROOM_MAX_MEMBERS)?;
println!("å½“å‰æœ€å¤§æˆå‘˜æ•°: {}", max_members);  // è¾“å‡º: 100ï¼ˆé»˜è®¤å€¼ï¼Œå·²å­˜å…¥æ•°æ®åº“ï¼‰

// æŸ¥çœ‹æ•°æ®åº“ï¼š
// psql> SELECT * FROM settings WHERE key = 'room.max_members';
// key               | value | category | description      | created_at | updated_at
// ----------------- | ----- | -------- | ---------------- | ---------- | ----------
// room.max_members  | 100   | room     | æˆ¿é—´æœ€å¤§æˆå‘˜æ•°    | 2024-...   | 2024-...

// 3. DBA ä¿®æ”¹é…ç½®
// psql> UPDATE settings SET value = '200' WHERE key = 'room.max_members';
// â†’ è§¦å‘å™¨è‡ªåŠ¨æ‰§è¡Œ: NOTIFY settings_changed, 'room.max_members'
// â†’ æ‰€æœ‰å‰¯æœ¬çš„ PgListener æ”¶åˆ°é€šçŸ¥
// â†’ è‡ªåŠ¨é‡æ–°åŠ è½½è¯¥é…ç½®: SELECT value FROM settings WHERE key = 'room.max_members'
// â†’ æ›´æ–°ç¼“å­˜: cache.insert("room.max_members", "200")

// 4. å®æ—¶ç”Ÿæ•ˆï¼ˆæ— éœ€é‡å¯ï¼‰
tokio::time::sleep(Duration::from_millis(100)).await;

let new_value = settings.get(&ROOM_MAX_MEMBERS)?;
println!("æ›´æ–°åçš„æœ€å¤§æˆå‘˜æ•°: {}", new_value);  // è¾“å‡º: 200ï¼ˆè‡ªåŠ¨ç”Ÿæ•ˆï¼‰

// ============================================
// ç¤ºä¾‹ 7: é…ç½®é”™è¯¯å¤„ç†ï¼ˆDBA å†™å…¥éæ³•å€¼ï¼‰
// ============================================

// DBA ä¸å°å¿ƒå†™å…¥äº†éæ³•å€¼
// psql> UPDATE settings SET value = 'invalid' WHERE key = 'room.max_members';

// è¯»å–é…ç½®æ—¶ä¼šè¿”å›é”™è¯¯
match settings.get(&ROOM_MAX_MEMBERS) {
    Ok(max) => println!("Max members: {}", max),
    Err(e) => {
        // Error::ConfigParseError {
        //     key: "room.max_members",
        //     value: "invalid",
        //     error: "invalid digit found in string"
        // }
        tracing::error!("Config error: {}", e);

        // é€‰æ‹©å¤„ç†æ–¹å¼ï¼š
        // 1. ä½¿ç”¨é»˜è®¤å€¼ç»§ç»­è¿è¡Œ
        let max = settings.get_or_default(&ROOM_MAX_MEMBERS);
        // 2. æˆ–è€…é˜»æ­¢æœåŠ¡å¯åŠ¨
        // panic!("Invalid config: {}", e);
    }
}

// ============================================
// ç¤ºä¾‹ 8: ç‰ˆæœ¬å‡çº§åœºæ™¯ï¼ˆæ–°å¢é…ç½®ï¼‰
// ============================================

// å‡è®¾æ–°ç‰ˆæœ¬æ–°å¢äº†ä¸€ä¸ªé…ç½®é¡¹
setting!(ROOM_MAX_PLAYLISTS: i64 =
    "room.max_playlists",
    "10",
    "room",
    "æ¯ä¸ªæˆ¿é—´æœ€å¤§æ’­æ”¾åˆ—è¡¨æ•°"
);

// é‡æ–°å¯åŠ¨æœåŠ¡
let settings = DynamicSettings::init(db_pool).await?;
// init_definitions() ä¼šæ£€æµ‹åˆ°æ–°é…ç½®:
//   â‘  å°è¯• INSERT room.max_playlists = '10'
//   â‘¡ ç”±äºä¸å­˜åœ¨ï¼Œæ’å…¥æˆåŠŸ
//   â‘¢ æ—¥å¿—: Inserted default setting: room.max_playlists = 10
//   â‘£ å…¶ä»–å·²å­˜åœ¨çš„é…ç½®ï¼ˆroom.max_members = 200ï¼‰ä¿æŒä¸å˜

// æ–°é…ç½®ç«‹å³å¯ç”¨ï¼Œä½¿ç”¨é»˜è®¤å€¼
let max_playlists = settings.get(&ROOM_MAX_PLAYLISTS)?;
println!("æœ€å¤§æ’­æ”¾åˆ—è¡¨æ•°: {}", max_playlists);  // è¾“å‡º: 10ï¼ˆæ–°é…ç½®çš„é»˜è®¤å€¼ï¼‰

// æ•°æ®åº“ä¸­ç°åœ¨æœ‰ï¼š
// - room.max_members = 200  (ä¿ç•™ç”¨æˆ·è‡ªå®šä¹‰å€¼)
// - room.max_playlists = 10 (æ–°æ’å…¥çš„é»˜è®¤å€¼)
```

### 6.5 ä¸šåŠ¡é€»è¾‘ä¸­ä½¿ç”¨åŠ¨æ€é…ç½®

```rust
pub struct RoomService {
    db_pool: PgPool,
    dynamic_settings: Arc<DynamicSettings>,  // æ³¨å…¥åŠ¨æ€é…ç½®
}

impl RoomService {
    pub async fn create_room(&self, user_id: &str, name: String) -> Result<Room> {  // nanoid(12)
        // è¯»å–åŠ¨æ€é…ç½®ï¼ˆå®æ—¶ç”Ÿæ•ˆçš„é…ç½®ï¼‰
        // ä½¿ç”¨ ? ä¼ æ’­é”™è¯¯ï¼šé…ç½®è§£æå¤±è´¥ä¼šå¯¼è‡´ API è¿”å›é”™è¯¯
        let disable_create = self.dynamic_settings.get(&ROOM_DISABLE_CREATE)?;

        if disable_create {
            return Err(Error::RoomCreationDisabled);
        }

        // ä½¿ç”¨ get_or_defaultï¼šå¦‚æœé…ç½®è§£æå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼
        let max_per_user = self.dynamic_settings.get_or_default(&ROOM_MAX_PER_USER);

        // æ£€æŸ¥ç”¨æˆ·åˆ›å»ºçš„æˆ¿é—´æ•°
        let count = sqlx::query_scalar!(
            "SELECT COUNT(*) FROM rooms WHERE creator_id = $1",
            user_id
        )
        .fetch_one(&self.db_pool)
        .await?;

        if count >= max_per_user {
            return Err(Error::RoomLimitExceeded);
        }

        // åˆ›å»ºæˆ¿é—´...
        Ok(room)
    }
}
```


## 7. é…ç½®åˆ†ç»„

### 7.1 åˆ†ç»„å®šä¹‰

```rust
pub mod groups {
    /// æœåŠ¡å™¨é…ç½®
    pub const SERVER: &str = "server";

    /// æ•°æ®åº“é…ç½®
    pub const DATABASE: &str = "database";

    /// Redisé…ç½®
    pub const REDIS: &str = "redis";

    /// æˆ¿é—´é…ç½®
    pub const ROOM: &str = "room";

    /// ç”¨æˆ·é…ç½®
    pub const USER: &str = "user";

    /// é‚®ä»¶é…ç½®
    pub const EMAIL: &str = "email";

    /// OAuth2é…ç½®
    pub const OAUTH2: &str = "oauth2";

    /// ä»£ç†é…ç½®
    pub const PROXY: &str = "proxy";

    /// RTMPé…ç½®
    pub const RTMP: &str = "rtmp";

    /// æ—¥å¿—é…ç½®
    pub const LOGGING: &str = "logging";

    /// åŠŸèƒ½å¼€å…³
    pub const FEATURES: &str = "features";
}
```

### 7.2 é™æ€é…ç½®ç»“æ„ä½“

```rust
/// é™æ€é…ç½®ï¼ˆåŸºç¡€è®¾æ–½ï¼Œå¯åŠ¨æ—¶åŠ è½½ï¼‰
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StaticConfig {
    pub server: ServerConfig,
    pub database: DatabaseConfig,
    pub redis: RedisConfig,
    pub email: EmailConfig,
    pub oauth2: OAuth2Config,
    pub rtmp: RtmpConfig,
    pub logging: LoggingConfig,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ServerConfig {
    pub host: String,
    pub port: u16,
    pub external_url: String,
    pub tls: Option<TlsConfig>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DatabaseConfig {
    pub url: String,
    pub max_connections: u32,
    pub min_connections: u32,
    pub connect_timeout: u64,
}
```

### 7.3 åŠ¨æ€é…ç½®å‘½åè§„èŒƒ

åŠ¨æ€é…ç½®ä½¿ç”¨ **ç‚¹åˆ†éš”å‘½å**ï¼Œå­˜å‚¨åœ¨ settings è¡¨ï¼š

| åˆ†ç±» | é…ç½®é”®ç¤ºä¾‹ | ç±»å‹ | è¯´æ˜ |
|-----|----------|------|------|
| **room** | `room.disable_create` | boolean | ç¦ç”¨æˆ¿é—´åˆ›å»º |
| | `room.require_approval` | boolean | æˆ¿é—´éœ€è¦å®¡æ ¸ |
| | `room.max_members` | number | æˆ¿é—´æœ€å¤§æˆå‘˜æ•° |
| | `room.ttl_hours` | number | æˆ¿é—´TTLï¼ˆå°æ—¶ï¼‰ |
| **user** | `user.disable_signup` | boolean | ç¦ç”¨ç”¨æˆ·æ³¨å†Œ |
| | `user.require_approval` | boolean | ç”¨æˆ·éœ€è¦å®¡æ ¸ |
| | `user.max_room_count` | number | æ¯ç”¨æˆ·æœ€å¤šåˆ›å»ºæˆ¿é—´æ•° |
| | `user.enable_guest` | boolean | å¯ç”¨æ¸¸å®¢æ¨¡å¼ |
| **proxy** | `proxy.enable_movie` | boolean | å¯ç”¨ç”µå½±ä»£ç† |
| | `proxy.enable_live` | boolean | å¯ç”¨ç›´æ’­ä»£ç† |
| **rate_limit** | `rate_limit.chat_per_user` | number | èŠå¤©é™æµï¼ˆæ¡/ç§’ï¼‰ |
| | `rate_limit.danmaku_per_user` | number | å¼¹å¹•é™æµï¼ˆæ¡/ç§’ï¼‰ |

**è¯»å–ç¤ºä¾‹**ï¼š

```rust
// æ–¹å¼ 1: è¿”å› Resultï¼ˆæ˜¾å¼é”™è¯¯å¤„ç†ï¼‰
let max_members = dynamic_settings.get(&ROOM_MAX_MEMBERS)?;  // Result<i64>
let disable_signup = dynamic_settings.get(&USER_DISABLE_SIGNUP)?;  // Result<bool>

// æ–¹å¼ 2: get_or_defaultï¼ˆè‡ªåŠ¨ä½¿ç”¨é»˜è®¤å€¼ï¼‰
let max_members = dynamic_settings.get_or_default(&ROOM_MAX_MEMBERS);  // i64
let disable_signup = dynamic_settings.get_or_default(&USER_DISABLE_SIGNUP);  // bool
```

### 7.4 é”™è¯¯å¤„ç†ç­–ç•¥

`get()` æ–¹æ³•è¿”å› `Result` çš„è®¾è®¡ç†ç”±ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **æ˜ç¡®é”™è¯¯** | é…ç½®è§£æå¤±è´¥æ—¶è¿”å›è¯¦ç»†é”™è¯¯ï¼ˆkey, value, errorï¼‰ |
| **çµæ´»å¤„ç†** | è°ƒç”¨è€…å¯é€‰æ‹©ï¼šå¿«é€Ÿå¤±è´¥ï¼ˆ`?`ï¼‰ã€é™çº§ï¼ˆ`get_or_default`ï¼‰ã€è‡ªå®šä¹‰å¤„ç†ï¼ˆ`match`ï¼‰ |
| **é…ç½®éªŒè¯** | å¯åŠ¨æ—¶å¯éªŒè¯æ‰€æœ‰å…³é”®é…ç½®ï¼Œé¿å…è¿è¡Œæ—¶é”™è¯¯ |
| **è°ƒè¯•å‹å¥½** | æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯ä¾¿äºå®šä½é…ç½®é—®é¢˜ |

**é”™è¯¯ç±»å‹**ï¼š

```rust
pub enum Error {
    // æ•°æ®åº“ä¸­çš„å€¼è§£æå¤±è´¥
    ConfigParseError {
        key: String,      // "room.max_members"
        value: String,    // "invalid"
        error: String,    // "invalid digit found in string"
    },

    // é»˜è®¤å€¼è§£æå¤±è´¥ï¼ˆç¼–ç¨‹é”™è¯¯ï¼Œåº”åœ¨å¼€å‘æ—¶å‘ç°ï¼‰
    InvalidDefaultValue {
        key: String,
        default_value: String,
        error: String,
    },
}
```

**ä½¿ç”¨å»ºè®®**ï¼š

- **å…³é”®é…ç½®**ï¼šä½¿ç”¨ `get()` + `?`ï¼Œé…ç½®é”™è¯¯é˜»æ­¢æœåŠ¡å¯åŠ¨
- **éå…³é”®é…ç½®**ï¼šä½¿ç”¨ `get_or_default()`ï¼Œé…ç½®é”™è¯¯é™çº§åˆ°é»˜è®¤å€¼
- **å¯åŠ¨éªŒè¯**ï¼šåœ¨ `main()` ä¸­ä½¿ç”¨ `expect()` éªŒè¯æ‰€æœ‰å…³é”®é…ç½®

---

## 8. å®ç°æ–¹æ¡ˆ

### 8.1 ä¾èµ–åº“

```toml
[dependencies]
config = "0.14"                 # é™æ€é…ç½®åŠ è½½
serde = { version = "1.0", features = ["derive"] }
clap = { version = "4.4", features = ["derive"] }
sqlx = { version = "0.7", features = ["postgres", "runtime-tokio-rustls"] }
dashmap = "5.5"                 # åŠ¨æ€é…ç½®å†…å­˜ç¼“å­˜
inventory = "0.3"               # é…ç½®å®šä¹‰æ”¶é›†ï¼ˆç¼–è¯‘æ—¶ï¼‰
once_cell = "1.19"              # å…¨å±€é™æ€å˜é‡
```

### 8.2 å®Œæ•´åˆå§‹åŒ–æµç¨‹

```rust
use config::{Config, File, Environment};

/// åº”ç”¨ç¨‹åºçŠ¶æ€ï¼ˆåŒ…å«é™æ€å’ŒåŠ¨æ€é…ç½®ï¼‰
pub struct AppState {
    /// é™æ€é…ç½®ï¼ˆå¯åŠ¨æ—¶åŠ è½½ï¼Œéœ€è¦é‡å¯ç”Ÿæ•ˆï¼‰
    pub static_config: Arc<StaticConfig>,

    /// åŠ¨æ€é…ç½®ï¼ˆè¿è¡Œæ—¶å¯ä¿®æ”¹ï¼Œå®æ—¶ç”Ÿæ•ˆï¼‰
    pub dynamic_settings: Arc<DynamicSettings>,

    /// æ•°æ®åº“è¿æ¥æ± 
    pub db_pool: PgPool,

    /// Redis è¿æ¥æ± 
    pub redis_pool: RedisPool,
}

impl AppState {
    /// åˆå§‹åŒ–åº”ç”¨ç¨‹åºï¼ˆå¯åŠ¨æµç¨‹ï¼‰
    pub async fn init(cli: Cli) -> Result<Self> {
        tracing::info!("ğŸš€ Initializing SyncTV server");

        // ============ ç¬¬ä¸€æ­¥ï¼šåŠ è½½é™æ€é…ç½® ============
        tracing::info!("ğŸ“ Loading static configuration...");
        let static_config = load_static_config(&cli).await?;
        tracing::info!("âœ… Static configuration loaded");

        // ============ ç¬¬äºŒæ­¥ï¼šè¿æ¥åŸºç¡€è®¾æ–½ ============
        tracing::info!("ğŸ”Œ Connecting to database...");
        let db_pool = PgPoolOptions::new()
            .max_connections(static_config.database.max_connections)
            .connect(&static_config.database.url)
            .await?;
        tracing::info!("âœ… Database connected");

        tracing::info!("ğŸ”Œ Connecting to Redis...");
        let redis_pool = RedisPool::new(&static_config.redis.url).await?;
        tracing::info!("âœ… Redis connected");

        // ============ ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–åŠ¨æ€é…ç½®ç³»ç»Ÿ ============
        tracing::info!("âš™ï¸  Initializing dynamic settings...");
        let dynamic_settings = DynamicSettings::init(db_pool.clone()).await?;
        // æ—¥å¿—è¾“å‡º:
        // Syncing setting definitions to database...
        // Inserted default setting: room.disable_create = false
        // Inserted default setting: room.max_members = 100
        // Setting definitions synced: 12 inserted, 3 already exist
        // Loaded 15 settings from database
        // PostgreSQL LISTEN started for settings_changed
        tracing::info!("âœ… Dynamic settings initialized");

        Ok(Self {
            static_config: Arc::new(static_config),
            dynamic_settings: Arc::new(dynamic_settings),
            db_pool,
            redis_pool,
        })
    }
}

/// åŠ è½½é™æ€é…ç½®ï¼ˆCLI + ENV + Fileï¼‰
async fn load_static_config(cli: &Cli) -> Result<StaticConfig> {
    let mut builder = Config::builder();

    // 1. åŠ è½½é»˜è®¤å€¼
    builder = builder.add_source(Config::try_from(&StaticConfig::default())?);

    // 2. åŠ è½½é…ç½®æ–‡ä»¶ (é™¤é --skip-config)
    if !cli.skip_config {
        builder = builder.add_source(
            File::with_name(cli.config.to_str().unwrap())
                .required(false)
        );
    }

    // 3. åŠ è½½ç¯å¢ƒå˜é‡ (é™¤é --skip-env)
    if !cli.skip_env {
        builder = builder.add_source(
            Environment::with_prefix("SYNCTV")
                .separator("_")
                .try_parsing(true)
        );
    }

    // 4. åº”ç”¨CLIå‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    builder = apply_cli_overrides(builder, cli);

    // 5. æ„å»ºé™æ€é…ç½®
    let config = builder.build()?.try_deserialize::<StaticConfig>()?;

    // 6. éªŒè¯é™æ€é…ç½®
    config.validate()?;

    Ok(config)
}
```

### 8.3 é™æ€é…ç½®éªŒè¯

```rust
impl StaticConfig {
    /// éªŒè¯é™æ€é…ç½®çš„æœ‰æ•ˆæ€§
    pub fn validate(&self) -> Result<()> {
        // éªŒè¯æ•°æ®åº“URL
        if self.database.url.is_empty() {
            return Err(Error::InvalidConfig("database.url is required"));
        }

        // éªŒè¯Redis URL
        if self.redis.url.is_empty() {
            return Err(Error::InvalidConfig("redis.url is required"));
        }

        // éªŒè¯ç«¯å£èŒƒå›´
        if self.server.port == 0 || self.server.port > 65535 {
            return Err(Error::InvalidConfig("server.port must be 1-65535"));
        }

        // éªŒè¯OAuth2é…ç½®å®Œæ•´æ€§
        for (name, provider) in &self.oauth2.providers {
            if provider.enabled {
                if provider.client_id.is_empty() {
                    return Err(Error::InvalidConfig(
                        format!("oauth2.{}.client_id is required", name)
                    ));
                }
                if provider.client_secret.is_empty() {
                    return Err(Error::InvalidConfig(
                        format!("oauth2.{}.client_secret is required", name)
                    ));
                }
            }
        }

        // éªŒè¯é‚®ä»¶é…ç½®
        if self.email.enabled {
            if self.email.smtp_host.is_empty() {
                return Err(Error::InvalidConfig("email.smtp_host is required"));
            }
        }

        Ok(())
    }
}
```

### 8.4 ä½¿ç”¨ç¤ºä¾‹ï¼šåŒæ—¶ä½¿ç”¨é™æ€å’ŒåŠ¨æ€é…ç½®

```rust
#[tokio::main]
async fn main() -> Result<()> {
    // è§£æCLIå‚æ•°
    let cli = Cli::parse();

    // åˆå§‹åŒ–åº”ç”¨ï¼ˆåŠ è½½é™æ€é…ç½® + åŠ¨æ€é…ç½®ï¼‰
    let app_state = AppState::init(cli).await?;

    // ============ ä½¿ç”¨é™æ€é…ç½® ============
    // é™æ€é…ç½®åœ¨å¯åŠ¨æ—¶ç¡®å®šï¼Œä¿®æ”¹åéœ€è¦é‡å¯
    let addr = format!("{}:{}",
        app_state.static_config.server.host,
        app_state.static_config.server.port
    );
    tracing::info!("Server listening on {}", addr);

    // ============ ä½¿ç”¨åŠ¨æ€é…ç½® ============
    // åŠ¨æ€é…ç½®å¯è¿è¡Œæ—¶ä¿®æ”¹ï¼Œå®æ—¶ç”Ÿæ•ˆ
    // å¯åŠ¨æ—¶éªŒè¯å…³é”®é…ç½®
    let max_members = app_state.dynamic_settings.get(&ROOM_MAX_MEMBERS)
        .expect("Failed to parse ROOM_MAX_MEMBERS config");
    tracing::info!("Room max members: {}", max_members);

    // å¯åŠ¨æœåŠ¡å™¨
    start_server(app_state, &addr).await?;

    Ok(())
}

/// ä¸šåŠ¡é€»è¾‘ä¸­åŒæ—¶ä½¿ç”¨ä¸¤ç§é…ç½®
async fn handle_create_room(
    app_state: &AppState,
    user_id: &str,  // nanoid(12)
) -> Result<Room> {
    // ä½¿ç”¨åŠ¨æ€é…ç½®ï¼ˆå¯è¿è¡Œæ—¶ä¿®æ”¹ï¼‰
    // ä¼ æ’­é”™è¯¯ï¼šé…ç½®è§£æå¤±è´¥ä¼šå¯¼è‡´ API è¿”å› 500
    let disable_create = app_state.dynamic_settings.get(&ROOM_DISABLE_CREATE)?;

    if disable_create {
        return Err(Error::RoomCreationDisabled);
    }

    // ä½¿ç”¨é™æ€é…ç½®ï¼ˆéœ€è¦é‡å¯æ‰èƒ½ä¿®æ”¹ï¼‰
    let external_url = &app_state.static_config.server.external_url;

    // åˆ›å»ºæˆ¿é—´é€»è¾‘...
    Ok(room)
}
```

---

## æ€»ç»“

æœ¬ç« èŠ‚è®¾è®¡äº†ä¸€ä¸ª**åŒå±‚é…ç½®ç³»ç»Ÿ**ï¼Œä¸¥æ ¼åŒºåˆ†é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®ï¼š

### é™æ€é…ç½®ï¼ˆåŸºç¡€è®¾æ–½ï¼‰

âœ… **æ¥æº**: CLI > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
âœ… **ç”Ÿæ•ˆæ–¹å¼**: å¯åŠ¨æ—¶åŠ è½½ï¼Œ**ä¿®æ”¹åéœ€è¦é‡å¯**
âœ… **ç”¨é€”**: æ•°æ®åº“è¿æ¥ã€Redisè¿æ¥ã€æœåŠ¡å™¨ç«¯å£ã€TLSè¯ä¹¦ã€OAuth2å‡­è¯ç­‰
âœ… **ç¤ºä¾‹**: `--port 8080`, `DATABASE_URL=postgres://...`

### åŠ¨æ€é…ç½®ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰

âœ… **å®šä¹‰æ–¹å¼**: ä½¿ç”¨ `setting!` å®å®šä¹‰ï¼Œç¼–è¯‘æ—¶æ³¨å†Œ
âœ… **åˆå§‹åŒ–**: å¯åŠ¨æ—¶è‡ªåŠ¨åŒæ­¥å®šä¹‰åˆ°æ•°æ®åº“ï¼ˆä¸å­˜åœ¨åˆ™æ’å…¥é»˜è®¤å€¼ï¼‰
âœ… **å­˜å‚¨**: PostgreSQL settings è¡¨ï¼ˆç»Ÿä¸€å­˜å‚¨ä¸º TEXTï¼‰
âœ… **ç”Ÿæ•ˆæ–¹å¼**: **å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯**
âœ… **å¤šå‰¯æœ¬åŒæ­¥**: é€šè¿‡ PostgreSQL LISTEN/NOTIFY æ¯«ç§’çº§åŒæ­¥
âœ… **ç”¨é€”**: æˆ¿é—´é™åˆ¶ã€ç”¨æˆ·æƒé™ã€åŠŸèƒ½å¼€å…³ã€é™æµé…ç½®ç­‰
âœ… **ä¿®æ”¹æ–¹å¼**: ç›´æ¥ SQLã€Web UIã€CLI å‘½ä»¤ (`synctv setting set`)
âœ… **ç‰ˆæœ¬å‡çº§**: æ–°å¢é…ç½®è‡ªåŠ¨æ’å…¥é»˜è®¤å€¼ï¼Œå·²å­˜åœ¨çš„ä¿ç•™ç”¨æˆ·è‡ªå®šä¹‰å€¼

### æ ¸å¿ƒåŸåˆ™

âš ï¸ **é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿ**
âš ï¸ **å®ƒä»¬æ²¡æœ‰ä¼˜å…ˆçº§å…³ç³»ï¼Œç®¡ç†ä¸åŒç±»å‹çš„é…ç½®é¡¹**
âš ï¸ **é™æ€é…ç½® â‰  åŠ¨æ€é…ç½®ï¼Œä¸è¦æ··ä¸ºä¸€è°ˆ**

### è®¾è®¡ä¼˜åŠ¿

âœ… **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥ï¼Œé›¶è¿è¡Œæ—¶é”™è¯¯
âœ… **è‡ªåŠ¨åˆå§‹åŒ–**: å¯åŠ¨æ—¶è‡ªåŠ¨åŒæ­¥é…ç½®å®šä¹‰åˆ°æ•°æ®åº“ï¼Œæ— éœ€æ‰‹åŠ¨è¿ç§»
âœ… **ç‰ˆæœ¬å‡çº§å‹å¥½**: æ–°é…ç½®è‡ªåŠ¨æ’å…¥ï¼Œæ—§é…ç½®ä¿ç•™ï¼Œæ— ç¼å‡çº§
âœ… **å¤šå‰¯æœ¬æ”¯æŒ**: åŠ¨æ€é…ç½®é€šè¿‡ PostgreSQL LISTEN/NOTIFY å®æ—¶åŒæ­¥
âœ… **æ˜“äºéƒ¨ç½²**: Dockerã€Kubernetesã€è£¸æœºéƒ½æ”¯æŒ
âœ… **è°ƒè¯•å‹å¥½**: å¯è¿½è¸ªæ¯ä¸ªé…ç½®å€¼çš„æ¥æº
âœ… **è¿è¥å‹å¥½**: åŠ¨æ€é…ç½®æ”¯æŒçƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡
âœ… **é›¶ä¾èµ–**: æ— éœ€ Redisï¼Œåªéœ€ PostgreSQL

**ä¸‹ä¸€ç« **: [20-CLIå‘½ä»¤è®¾è®¡](./20-CLIå‘½ä»¤è®¾è®¡.md)

---

**ä¸Šä¸€ç« **: [18-APIæ–‡æ¡£ç”Ÿæˆæ–¹æ¡ˆ](./18-APIæ–‡æ¡£ç”Ÿæˆæ–¹æ¡ˆ.md)
**ä¸‹ä¸€ç« **: [20-CLIå‘½ä»¤è®¾è®¡](./20-CLIå‘½ä»¤è®¾è®¡.md)
