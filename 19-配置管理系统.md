# 19. é…ç½®ç®¡ç†ç³»ç»Ÿ

---

## ç›®å½•

- [1. è®¾è®¡ç†å¿µ](#1-è®¾è®¡ç†å¿µ)
- [2. é™æ€é…ç½®åŠ è½½](#2-é™æ€é…ç½®åŠ è½½)
- [3. é…ç½®æ–‡ä»¶æ ¼å¼](#3-é…ç½®æ–‡ä»¶æ ¼å¼)
- [4. ç¯å¢ƒå˜é‡æ˜ å°„](#4-ç¯å¢ƒå˜é‡æ˜ å°„)
- [5. CLI å‚æ•°è®¾è®¡](#5-cli-å‚æ•°è®¾è®¡)
- [6. åŠ¨æ€é…ç½®ç³»ç»Ÿï¼ˆdb_settingsï¼‰](#6-åŠ¨æ€é…ç½®ç³»ç»Ÿdb_settings)
- [7. é…ç½®åˆ†ç»„](#7-é…ç½®åˆ†ç»„)
- [8. å®ç°æ–¹æ¡ˆ](#8-å®ç°æ–¹æ¡ˆ)

---

## 1. è®¾è®¡ç†å¿µ

### 1.1 æ ¸å¿ƒåŸåˆ™

SyncTV ä½¿ç”¨ **åŒå±‚é…ç½®ç³»ç»Ÿ**ï¼Œä¸¥æ ¼åŒºåˆ†é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®ï¼š

| é…ç½®ç±»å‹ | æ¥æº | å˜æ›´æ–¹å¼ | ç”Ÿæ•ˆæ–¹å¼ | ç”¨é€” |
|---------|------|---------|---------|------|
| **é™æ€é…ç½®** | CLI/ENV/File | ä¿®æ”¹æ–‡ä»¶/ç¯å¢ƒå˜é‡ | **éœ€è¦é‡å¯** | åŸºç¡€è®¾æ–½é…ç½® |
| **åŠ¨æ€é…ç½®** | Database (settingsè¡¨) | Web UI / CLI å‘½ä»¤ | **å®æ—¶ç”Ÿæ•ˆ** | ä¸šåŠ¡è§„åˆ™é…ç½® |

**å…³é”®åŒºåˆ«**ï¼š

- âŒ **é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®æ²¡æœ‰ä¼˜å…ˆçº§å…³ç³»**
- âœ… å®ƒä»¬æ˜¯ä¸¤ä¸ª**ç‹¬ç«‹çš„é…ç½®ç³»ç»Ÿ**ï¼Œç®¡ç†ä¸åŒç±»å‹çš„é…ç½®é¡¹
- âœ… é™æ€é…ç½®ç”¨äºåŸºç¡€è®¾æ–½ï¼ˆæ•°æ®åº“ã€Redisã€ç«¯å£ç­‰ï¼‰
- âœ… åŠ¨æ€é…ç½®ç”¨äºä¸šåŠ¡è§„åˆ™ï¼ˆæˆ¿é—´é™åˆ¶ã€ç”¨æˆ·æƒé™ç­‰ï¼‰

### 1.2 é™æ€é…ç½®æ¶æ„

**ç”¨é€”**: æœåŠ¡å™¨å¯åŠ¨å‚æ•°ã€åŸºç¡€è®¾æ–½è¿æ¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           CLI å‚æ•° (æœ€é«˜ä¼˜å…ˆçº§)                       â”‚
â”‚  --database-url postgres://...                       â”‚
â”‚  --redis-url redis://...                             â”‚
â”‚  --port 8080                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¯å¢ƒå˜é‡                                 â”‚
â”‚  SYNCTV_DATABASE_URL=postgres://...                  â”‚
â”‚  SYNCTV_REDIS_URL=redis://...                        â”‚
â”‚  SYNCTV_SERVER_PORT=8080                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é…ç½®æ–‡ä»¶ (config.yaml)                     â”‚
â”‚  database:                                           â”‚
â”‚    url: "postgres://..."                             â”‚
â”‚  server:                                             â”‚
â”‚    port: 8080                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            é»˜è®¤å€¼ (ä»£ç ä¸­å®šä¹‰)                        â”‚
â”‚  const DEFAULT_PORT: u16 = 8080;                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¼˜å…ˆçº§: CLI > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
ç”Ÿæ•ˆæ–¹å¼: å¯åŠ¨æ—¶åŠ è½½ï¼Œä¿®æ”¹åéœ€è¦é‡å¯
```

### 1.3 åŠ¨æ€é…ç½®æ¶æ„

**ç”¨é€”**: ä¸šåŠ¡è§„åˆ™ã€åŠŸèƒ½å¼€å…³ã€è¿è¥é…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Web UI / CLI å‘½ä»¤                        â”‚
â”‚  synctv setting set room.max_members 50              â”‚
â”‚  UI: Settings -> Room -> Max Members = 50           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PostgreSQL (settings è¡¨)                      â”‚
â”‚  key: room.max_members                               â”‚
â”‚  value: "50"                                         â”‚
â”‚  updated_at: 2024-01-30 10:30:00                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Redis Pub/Sub (å®æ—¶åŒæ­¥)                      â”‚
â”‚  PUBLISH settings:changed {                          â”‚
â”‚    "key": "room.max_members",                        â”‚
â”‚    "value": 50                                       â”‚
â”‚  }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         æ‰€æœ‰å‰¯æœ¬ (å†…å­˜ç¼“å­˜)                            â”‚
â”‚  DashMap<String, SettingValue>                       â”‚
â”‚  å®æ—¶æ›´æ–°ï¼Œæ— éœ€é‡å¯                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”Ÿæ•ˆæ–¹å¼: ä¿®æ”¹åç«‹å³åŒæ­¥åˆ°æ‰€æœ‰å‰¯æœ¬ï¼Œæ— éœ€é‡å¯
```

---

## 2. é™æ€é…ç½®åŠ è½½

### 2.1 é…ç½®åˆ†ç±»

**é™æ€é…ç½®é¡¹**ï¼ˆå¯åŠ¨æ—¶åŠ è½½ï¼Œéœ€è¦é‡å¯ï¼‰ï¼š

| åˆ†ç±» | é…ç½®é¡¹ç¤ºä¾‹ | è¯´æ˜ |
|-----|----------|------|
| **æœåŠ¡å™¨** | host, port, external_url | æœåŠ¡å™¨ç›‘å¬åœ°å€ã€ç«¯å£ |
| **æ•°æ®åº“** | database_url, max_connections | PostgreSQL è¿æ¥é…ç½® |
| **Redis** | redis_url, cluster_urls | Redis è¿æ¥é…ç½® |
| **TLS** | cert_path, key_path | TLS è¯ä¹¦é…ç½® |
| **OAuth2** | client_id, client_secret | OAuth2 å®¢æˆ·ç«¯å‡­è¯ |
| **é‚®ä»¶** | smtp_host, smtp_username, smtp_password | SMTP æœåŠ¡å™¨é…ç½® |
| **RTMP** | rtmp_port | RTMP æœåŠ¡ç«¯å£ |
| **æ—¥å¿—** | log_level, log_format | æ—¥å¿—é…ç½® |

**åŠ¨æ€é…ç½®é¡¹**ï¼ˆè¿è¡Œæ—¶ä¿®æ”¹ï¼Œå®æ—¶ç”Ÿæ•ˆï¼‰ï¼š

| åˆ†ç±» | é…ç½®é¡¹ç¤ºä¾‹ | è¯´æ˜ |
|-----|----------|------|
| **æˆ¿é—´** | max_members, require_approval | æˆ¿é—´åˆ›å»ºè§„åˆ™ |
| **ç”¨æˆ·** | disable_signup, max_room_count | ç”¨æˆ·æ³¨å†Œè§„åˆ™ |
| **åŠŸèƒ½** | enable_guest, enable_webrtc | åŠŸèƒ½å¼€å…³ |
| **é™æµ** | rate_limit_per_user | é™æµé…ç½® |
| **ä»£ç†** | enable_movie_proxy | ä»£ç†å¼€å…³ |

### 2.2 é™æ€é…ç½®ä¼˜å…ˆçº§

```rust
pub enum StaticConfigSource {
    /// CLI å‚æ•° (ä¼˜å…ˆçº§: 1 - æœ€é«˜)
    Cli,
    /// ç¯å¢ƒå˜é‡ (ä¼˜å…ˆçº§: 2)
    Env,
    /// é…ç½®æ–‡ä»¶ (ä¼˜å…ˆçº§: 3)
    File,
    /// é»˜è®¤å€¼ (ä¼˜å…ˆçº§: 4 - æœ€ä½)
    Default,
}

/// é…ç½®å€¼çš„æ¥æºè¿½è¸ª (ç”¨äºè°ƒè¯•)
pub struct StaticConfigValue<T> {
    pub value: T,
    pub source: StaticConfigSource,
}

impl<T> StaticConfigValue<T> {
    /// åˆå¹¶å¤šä¸ªé™æ€é…ç½®æº,ä¼˜å…ˆçº§é«˜çš„è¦†ç›–ä¼˜å…ˆçº§ä½çš„
    pub fn merge(sources: Vec<(StaticConfigSource, Option<T>)>) -> Option<Self> {
        sources
            .into_iter()
            .filter_map(|(source, value)| value.map(|v| (source, v)))
            .min_by_key(|(source, _)| *source as u8)
            .map(|(source, value)| Self { value, source })
    }
}
```

### 2.3 é™æ€é…ç½®åŠ è½½æµç¨‹

```rust
pub struct StaticConfigLoader {
    cli_args: CliArgs,
    env_vars: HashMap<String, String>,
    file_config: Option<FileConfig>,
}

impl StaticConfigLoader {
    /// åŠ è½½é™æ€é…ç½®ï¼ˆåŸºç¡€è®¾æ–½é…ç½®ï¼‰
    pub async fn load() -> Result<StaticConfig> {
        let loader = Self {
            cli_args: parse_cli_args(),
            env_vars: load_env_vars(),
            file_config: load_file_config()?,
        };

        // æ„å»ºé™æ€é…ç½® (CLI + Env + File + Default)
        let config = loader.build_config()?;

        // éªŒè¯é…ç½®
        config.validate()?;

        Ok(config)
    }

    fn build_config(&self) -> Result<StaticConfig> {
        StaticConfig {
            server: self.load_server_config()?,
            database: self.load_database_config()?,
            redis: self.load_redis_config()?,
            oauth2: self.load_oauth2_config()?,
            email: self.load_email_config()?,
            rtmp: self.load_rtmp_config()?,
            logging: self.load_logging_config()?,
        }
    }

    fn load_server_config(&self) -> Result<ServerConfig> {
        Ok(ServerConfig {
            host: StaticConfigValue::merge(vec![
                (StaticConfigSource::Cli, self.cli_args.host.clone()),
                (StaticConfigSource::Env, self.env_vars.get("SERVER_HOST").cloned()),
                (StaticConfigSource::File, self.file_config.as_ref()
                    .and_then(|f| f.server.host.clone())),
                (StaticConfigSource::Default, Some("0.0.0.0".to_string())),
            ])
            .expect("default value should exist"),

            port: StaticConfigValue::merge(vec![
                (StaticConfigSource::Cli, self.cli_args.port),
                (StaticConfigSource::Env, self.env_vars.get("SERVER_PORT")
                    .and_then(|s| s.parse().ok())),
                (StaticConfigSource::File, self.file_config.as_ref()
                    .and_then(|f| f.server.port)),
                (StaticConfigSource::Default, Some(8080)),
            ])
            .expect("default value should exist"),

            // ...
        })
    }
}
```

---

## 3. é…ç½®æ–‡ä»¶æ ¼å¼

### 3.1 YAML æ ¼å¼

**config.yaml**:

```yaml
server:
  host: "0.0.0.0"
  port: 8080
  external_url: "https://synctv.example.com"
  tls:
    enabled: false
    cert_path: "/path/to/cert.pem"
    key_path: "/path/to/key.pem"

database:
  url: "postgres://synctv:password@localhost:5432/synctv"
  max_connections: 20
  min_connections: 5
  connect_timeout: 30
  idle_timeout: 600

redis:
  url: "redis://localhost:6379"
  max_connections: 10
  connect_timeout: 5

oauth2:
  github:
    enabled: true
    client_id: "your-github-client-id"
    client_secret: "your-github-client-secret"
  google:
    enabled: true
    client_id: "your-google-client-id"
    client_secret: "your-google-client-secret"

email:
  enabled: true
  smtp_host: "smtp.gmail.com"
  smtp_port: 587
  smtp_username: "your-email@gmail.com"
  smtp_password: "your-app-password"
  smtp_tls: true
  from_address: "noreply@synctv.example.com"
  from_name: "SyncTV"
  whitelist:
    enabled: false
    domains:
      - "example.com"
      - "company.com"

rtmp:
  enabled: true
  port: 1935
  max_bitrate: 6000

logging:
  level: "info"
  format: "json"
  output: "stdout"

features:
  enable_guest: true
  enable_room_password: true
  enable_webrtc: true
  enable_live_stream: true
```

---

## 4. ç¯å¢ƒå˜é‡æ˜ å°„

### 4.1 å‘½åè§„èŒƒ

**è§„åˆ™**: `{PREFIX}_{SECTION}_{KEY}` (å…¨éƒ¨å¤§å†™,ä¸‹åˆ’çº¿åˆ†éš”)

**ç¤ºä¾‹**:

```bash
# æœåŠ¡å™¨é…ç½®
SYNCTV_SERVER_HOST=0.0.0.0
SYNCTV_SERVER_PORT=8080
SYNCTV_SERVER_EXTERNAL_URL=https://synctv.example.com

# æ•°æ®åº“é…ç½®
SYNCTV_DATABASE_URL=postgres://synctv:password@localhost:5432/synctv
SYNCTV_DATABASE_MAX_CONNECTIONS=20

# Redisé…ç½®
SYNCTV_REDIS_URL=redis://localhost:6379

# OAuth2é…ç½®
SYNCTV_OAUTH2_GITHUB_ENABLED=true
SYNCTV_OAUTH2_GITHUB_CLIENT_ID=xxx
SYNCTV_OAUTH2_GITHUB_CLIENT_SECRET=yyy

# é‚®ä»¶é…ç½®
SYNCTV_EMAIL_ENABLED=true
SYNCTV_EMAIL_SMTP_HOST=smtp.gmail.com
SYNCTV_EMAIL_SMTP_PORT=587
SYNCTV_EMAIL_SMTP_USERNAME=your-email@gmail.com
SYNCTV_EMAIL_SMTP_PASSWORD=your-app-password

# RTMPé…ç½®
SYNCTV_RTMP_ENABLED=true
SYNCTV_RTMP_PORT=1935

# æ—¥å¿—é…ç½®
SYNCTV_LOGGING_LEVEL=info
SYNCTV_LOGGING_FORMAT=json

# åŠŸèƒ½å¼€å…³
SYNCTV_FEATURES_ENABLE_GUEST=true
SYNCTV_FEATURES_ENABLE_WEBRTC=true
```

### 4.2 ç¯å¢ƒå˜é‡è§£æ

```rust
use std::env;

pub struct EnvLoader {
    prefix: String,
}

impl EnvLoader {
    pub fn new(prefix: &str) -> Self {
        Self {
            prefix: prefix.to_uppercase(),
        }
    }

    pub fn load(&self) -> HashMap<String, String> {
        env::vars()
            .filter(|(key, _)| key.starts_with(&format!("{}_", self.prefix)))
            .map(|(key, value)| {
                // ç§»é™¤å‰ç¼€: SYNCTV_SERVER_HOST -> SERVER_HOST
                let key_without_prefix = key
                    .strip_prefix(&format!("{}_", self.prefix))
                    .unwrap()
                    .to_string();
                (key_without_prefix, value)
            })
            .collect()
    }

    /// å°†ç¯å¢ƒå˜é‡æ˜ å°„åˆ°é…ç½®ç»“æ„
    pub fn get<T: FromStr>(&self, key: &str) -> Option<T> {
        let env_key = format!("{}_{}", self.prefix, key.to_uppercase());
        env::var(&env_key).ok().and_then(|v| v.parse().ok())
    }

    /// è·å–åµŒå¥—é…ç½®: SERVER.HOST -> SERVER_HOST
    pub fn get_nested<T: FromStr>(&self, section: &str, key: &str) -> Option<T> {
        let env_key = format!(
            "{}_{}_{}",
            self.prefix,
            section.to_uppercase(),
            key.to_uppercase()
        );
        env::var(&env_key).ok().and_then(|v| v.parse().ok())
    }
}
```

### 4.3 Docker ç¯å¢ƒå˜é‡ç¤ºä¾‹

```dockerfile
# Dockerfile
FROM rust:1.75 AS builder
# ...

FROM debian:bookworm-slim
WORKDIR /app
COPY --from=builder /app/target/release/synctv .

# è®¾ç½®é»˜è®¤ç¯å¢ƒå˜é‡
ENV SYNCTV_SERVER_HOST=0.0.0.0 \
    SYNCTV_SERVER_PORT=8080 \
    SYNCTV_LOGGING_LEVEL=info \
    SYNCTV_FEATURES_ENABLE_GUEST=true

EXPOSE 8080

CMD ["./synctv", "server"]
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  synctv:
    image: synctv/synctv:latest
    environment:
      # æ•°æ®åº“é…ç½®
      SYNCTV_DATABASE_URL: postgres://synctv:${DB_PASSWORD}@postgres:5432/synctv
      SYNCTV_REDIS_URL: redis://redis:6379

      # OAuth2é…ç½®
      SYNCTV_OAUTH2_GITHUB_ENABLED: "true"
      SYNCTV_OAUTH2_GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      SYNCTV_OAUTH2_GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}

      # é‚®ä»¶é…ç½®
      SYNCTV_EMAIL_ENABLED: "true"
      SYNCTV_EMAIL_SMTP_HOST: smtp.gmail.com
      SYNCTV_EMAIL_SMTP_PORT: "587"
      SYNCTV_EMAIL_SMTP_USERNAME: ${EMAIL_USERNAME}
      SYNCTV_EMAIL_SMTP_PASSWORD: ${EMAIL_PASSWORD}

      # åŠŸèƒ½å¼€å…³
      SYNCTV_FEATURES_ENABLE_GUEST: "true"
      SYNCTV_FEATURES_ENABLE_WEBRTC: "true"
```

---

## 5. CLI å‚æ•°è®¾è®¡

### 5.1 å…¨å±€å‚æ•°

```bash
synctv [OPTIONS] <COMMAND>

OPTIONS:
  -c, --config <FILE>          é…ç½®æ–‡ä»¶è·¯å¾„ [default: config.yaml]
      --skip-config            è·³è¿‡é…ç½®æ–‡ä»¶åŠ è½½
      --skip-env               è·³è¿‡ç¯å¢ƒå˜é‡åŠ è½½
  -d, --data-dir <PATH>        æ•°æ®ç›®å½• [default: ./data]
      --log-level <LEVEL>      æ—¥å¿—çº§åˆ« [debug|info|warn|error]
      --log-format <FORMAT>    æ—¥å¿—æ ¼å¼ [json|pretty]
  -h, --help                   æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
  -V, --version                æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
```

### 5.2 server å­å‘½ä»¤

```bash
synctv server [OPTIONS]

å¯åŠ¨ SyncTV æœåŠ¡å™¨

OPTIONS:
      --host <HOST>                 ç›‘å¬åœ°å€ [default: 0.0.0.0]
  -p, --port <PORT>                 ç›‘å¬ç«¯å£ [default: 8080]
      --database-url <URL>          PostgreSQLè¿æ¥URL
      --redis-url <URL>             Redisè¿æ¥URL
      --external-url <URL>          å¤–éƒ¨è®¿é—®URL (ç”¨äºOAuth2å›è°ƒ)
      --disable-web                 ç¦ç”¨Webç•Œé¢
      --web-path <PATH>             Webé™æ€æ–‡ä»¶è·¯å¾„
      --rtmp-port <PORT>            RTMPç›‘å¬ç«¯å£ [default: 1935]
      --disable-rtmp                ç¦ç”¨RTMPæœåŠ¡
      --force-migrate               å¼ºåˆ¶æ‰§è¡Œæ•°æ®åº“è¿ç§»
  -h, --help                        æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯

EXAMPLES:
  # ä½¿ç”¨é…ç½®æ–‡ä»¶å¯åŠ¨
  synctv server --config config.yaml

  # ä½¿ç”¨CLIå‚æ•°è¦†ç›–é…ç½®
  synctv server --port 3000 --database-url postgres://...

  # è·³è¿‡é…ç½®æ–‡ä»¶,ä»…ä½¿ç”¨CLIå‚æ•°å’Œç¯å¢ƒå˜é‡
  synctv server --skip-config --port 3000
```

### 5.3 Clap v4 å®ç°

```rust
use clap::{Parser, Subcommand};

#[derive(Parser)]
#[command(name = "synctv")]
#[command(version, about, long_about = None)]
pub struct Cli {
    /// é…ç½®æ–‡ä»¶è·¯å¾„
    #[arg(short, long, value_name = "FILE", default_value = "config.yaml")]
    pub config: PathBuf,

    /// è·³è¿‡é…ç½®æ–‡ä»¶åŠ è½½
    #[arg(long)]
    pub skip_config: bool,

    /// è·³è¿‡ç¯å¢ƒå˜é‡åŠ è½½
    #[arg(long)]
    pub skip_env: bool,

    /// æ•°æ®ç›®å½•
    #[arg(short, long, value_name = "PATH", default_value = "./data")]
    pub data_dir: PathBuf,

    /// æ—¥å¿—çº§åˆ«
    #[arg(long, value_name = "LEVEL", value_parser = ["trace", "debug", "info", "warn", "error"])]
    pub log_level: Option<String>,

    /// æ—¥å¿—æ ¼å¼
    #[arg(long, value_name = "FORMAT", value_parser = ["json", "pretty"])]
    pub log_format: Option<String>,

    #[command(subcommand)]
    pub command: Commands,
}

#[derive(Subcommand)]
pub enum Commands {
    /// å¯åŠ¨æœåŠ¡å™¨
    Server {
        /// ç›‘å¬åœ°å€
        #[arg(long, default_value = "0.0.0.0")]
        host: String,

        /// ç›‘å¬ç«¯å£
        #[arg(short, long, default_value_t = 8080)]
        port: u16,

        /// PostgreSQLè¿æ¥URL
        #[arg(long)]
        database_url: Option<String>,

        /// Redisè¿æ¥URL
        #[arg(long)]
        redis_url: Option<String>,

        /// å¤–éƒ¨è®¿é—®URL
        #[arg(long)]
        external_url: Option<String>,

        /// ç¦ç”¨Webç•Œé¢
        #[arg(long)]
        disable_web: bool,

        /// Webé™æ€æ–‡ä»¶è·¯å¾„
        #[arg(long)]
        web_path: Option<PathBuf>,

        /// RTMPç›‘å¬ç«¯å£
        #[arg(long, default_value_t = 1935)]
        rtmp_port: u16,

        /// ç¦ç”¨RTMPæœåŠ¡
        #[arg(long)]
        disable_rtmp: bool,

        /// å¼ºåˆ¶æ‰§è¡Œæ•°æ®åº“è¿ç§»
        #[arg(long)]
        force_migrate: bool,
    },

    /// ç®¡ç†å‘˜ç®¡ç†
    Admin {
        #[command(subcommand)]
        command: AdminCommands,
    },

    /// Rootç”¨æˆ·ç®¡ç†
    Root {
        #[command(subcommand)]
        command: RootCommands,
    },

    /// ç”¨æˆ·ç®¡ç†
    User {
        #[command(subcommand)]
        command: UserCommands,
    },

    /// è®¾ç½®ç®¡ç†
    Setting {
        #[command(subcommand)]
        command: SettingCommands,
    },
}

#[derive(Subcommand)]
pub enum AdminCommands {
    /// æ·»åŠ ç®¡ç†å‘˜
    Add {
        username: String,
        password: String,
    },
    /// åˆ é™¤ç®¡ç†å‘˜
    Delete {
        username: String,
    },
    /// æ˜¾ç¤ºæ‰€æœ‰ç®¡ç†å‘˜
    Show,
}
```

---

## 6. åŠ¨æ€é…ç½®ç³»ç»Ÿï¼ˆdb_settingsï¼‰

### 6.1 æ ¸å¿ƒç‰¹æ€§

**ä¸é™æ€é…ç½®çš„æ ¹æœ¬åŒºåˆ«**ï¼š

| ç‰¹æ€§ | é™æ€é…ç½® (CLI/ENV/File) | åŠ¨æ€é…ç½® (db_settings) |
|-----|------------------------|----------------------|
| **å­˜å‚¨ä½ç½®** | é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ | PostgreSQL settings è¡¨ |
| **ä¿®æ”¹æ–¹å¼** | ç¼–è¾‘æ–‡ä»¶/ç¯å¢ƒå˜é‡ | Web UI / CLI å‘½ä»¤ |
| **ç”Ÿæ•ˆæ–¹å¼** | **éœ€è¦é‡å¯æœåŠ¡** | **ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯** |
| **å¤šå‰¯æœ¬åŒæ­¥** | æ‰‹åŠ¨åŒæ­¥ | **è‡ªåŠ¨åŒæ­¥ï¼ˆRedis Pub/Subï¼‰** |
| **é€‚ç”¨åœºæ™¯** | åŸºç¡€è®¾æ–½é…ç½® | ä¸šåŠ¡è§„åˆ™é…ç½® |
| **ç¤ºä¾‹** | æ•°æ®åº“URLã€æœåŠ¡å™¨ç«¯å£ | æˆ¿é—´æ•°é‡é™åˆ¶ã€åŠŸèƒ½å¼€å…³ |

### 6.2 è®¾ç½®è¡¨ç»“æ„

```sql
CREATE TABLE settings (
    key VARCHAR(255) PRIMARY KEY,
    value TEXT NOT NULL,
    value_type VARCHAR(50) NOT NULL,  -- string, number, boolean, json
    category VARCHAR(100) NOT NULL,   -- room, user, email, oauth2, etc.
    description TEXT,
    default_value TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),

    CHECK (value_type IN ('string', 'number', 'boolean', 'json'))
);

CREATE INDEX idx_settings_category ON settings(category);

-- åˆå§‹åŒ–é»˜è®¤è®¾ç½®
INSERT INTO settings (key, value, value_type, category, description, default_value) VALUES
('room.disable_create', 'false', 'boolean', 'room', 'ç¦ç”¨æˆ¿é—´åˆ›å»º', 'false'),
('room.require_approval', 'false', 'boolean', 'room', 'æˆ¿é—´åˆ›å»ºéœ€è¦å®¡æ ¸', 'false'),
('room.ttl_hours', '48', 'number', 'room', 'æˆ¿é—´æ— æ´»åŠ¨è‡ªåŠ¨å…³é—­æ—¶é—´(å°æ—¶)', '48'),
('user.disable_signup', 'false', 'boolean', 'user', 'ç¦ç”¨ç”¨æˆ·æ³¨å†Œ', 'false'),
('user.require_approval', 'false', 'boolean', 'user', 'ç”¨æˆ·æ³¨å†Œéœ€è¦å®¡æ ¸', 'false'),
('user.max_room_count', '3', 'number', 'user', 'æ¯ä¸ªç”¨æˆ·æœ€å¤šåˆ›å»ºæˆ¿é—´æ•°', '3'),
('user.enable_guest', 'true', 'boolean', 'user', 'å¯ç”¨æ¸¸å®¢æ¨¡å¼', 'true'),
('proxy.enable_movie', 'true', 'boolean', 'proxy', 'å¯ç”¨ç”µå½±ä»£ç†', 'true'),
('proxy.enable_live', 'true', 'boolean', 'proxy', 'å¯ç”¨ç›´æ’­ä»£ç†', 'true'),
('email.enable', 'false', 'boolean', 'email', 'å¯ç”¨é‚®ä»¶åŠŸèƒ½', 'false');
```

### 6.3 åŠ¨æ€é…ç½®åŠ è½½ä¸å®æ—¶åŒæ­¥

```rust
use dashmap::DashMap;
use std::sync::Arc;

/// åŠ¨æ€é…ç½®ç®¡ç†å™¨ï¼ˆç‹¬ç«‹äºé™æ€é…ç½®ï¼‰
pub struct DynamicSettings {
    /// å†…å­˜ç¼“å­˜ï¼Œæ‰€æœ‰å‰¯æœ¬æœ¬åœ°ç»´æŠ¤
    cache: Arc<DashMap<String, SettingValue>>,
    db_pool: PgPool,
    redis_pool: RedisPool,
}

#[derive(Clone, Debug, Serialize, Deserialize)]
pub enum SettingValue {
    String(String),
    Number(i64),
    Boolean(bool),
    Json(serde_json::Value),
}

impl DynamicSettings {
    /// åˆå§‹åŒ–åŠ¨æ€é…ç½®ç³»ç»Ÿ
    pub async fn init(db_pool: &PgPool, redis_pool: &RedisPool) -> Result<Self> {
        let settings = Self {
            cache: Arc::new(DashMap::new()),
            db_pool: db_pool.clone(),
            redis_pool: redis_pool.clone(),
        };

        // 1. ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰è®¾ç½®åˆ°å†…å­˜
        settings.load_from_db().await?;

        // 2. å¯åŠ¨ Redis Pub/Sub ç›‘å¬ï¼ˆå®æ—¶åŒæ­¥ï¼‰
        settings.start_sync_listener().await?;

        tracing::info!("Dynamic settings initialized with {} keys", settings.cache.len());

        Ok(settings)
    }

    /// ä»æ•°æ®åº“åŠ è½½æ‰€æœ‰è®¾ç½®
    async fn load_from_db(&self) -> Result<()> {
        let rows = sqlx::query!(
            "SELECT key, value, value_type FROM settings"
        )
        .fetch_all(&self.db_pool)
        .await?;

        for row in rows {
            let value = match row.value_type.as_str() {
                "string" => SettingValue::String(row.value),
                "number" => SettingValue::Number(row.value.parse()?),
                "boolean" => SettingValue::Boolean(row.value.parse()?),
                "json" => SettingValue::Json(serde_json::from_str(&row.value)?),
                _ => {
                    tracing::warn!("Unknown value_type: {}", row.value_type);
                    continue;
                }
            };
            self.cache.insert(row.key.clone(), value);
            tracing::debug!("Loaded setting: {}", row.key);
        }

        Ok(())
    }

    /// å¯åŠ¨ Redis Pub/Sub ç›‘å¬å™¨ï¼ˆå®æ—¶åŒæ­¥æ‰€æœ‰å‰¯æœ¬ï¼‰
    async fn start_sync_listener(&self) -> Result<()> {
        let cache = self.cache.clone();
        let mut pubsub = self.redis_pool.get_async_connection().await?.into_pubsub();

        pubsub.subscribe("settings:changed").await?;

        tokio::spawn(async move {
            tracing::info!("Dynamic settings sync listener started");

            while let Some(msg) = pubsub.on_message().next().await {
                let payload: String = match msg.get_payload() {
                    Ok(p) => p,
                    Err(e) => {
                        tracing::error!("Failed to parse Redis message: {}", e);
                        continue;
                    }
                };

                match serde_json::from_str::<SettingChange>(&payload) {
                    Ok(change) => {
                        tracing::info!("ğŸ”„ Setting changed: {} = {:?}", change.key, change.value);

                        // å®æ—¶æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼Œæ— éœ€é‡å¯
                        cache.insert(change.key.clone(), change.value);
                    }
                    Err(e) => {
                        tracing::error!("Failed to deserialize setting change: {}", e);
                    }
                }
            }
        });

        Ok(())
    }

    /// è¯»å–è®¾ç½®å€¼
    pub fn get_string(&self, key: &str) -> Option<String> {
        self.cache.get(key)
            .and_then(|v| match v.value() {
                SettingValue::String(s) => Some(s.clone()),
                _ => None,
            })
    }

    pub fn get_bool(&self, key: &str) -> Option<bool> {
        self.cache.get(key)
            .and_then(|v| match v.value() {
                SettingValue::Boolean(b) => Some(*b),
                _ => None,
            })
    }

    pub fn get_number(&self, key: &str) -> Option<i64> {
        self.cache.get(key)
            .and_then(|v| match v.value() {
                SettingValue::Number(n) => Some(*n),
                _ => None,
            })
    }

    /// æ›´æ–°è®¾ç½®ï¼ˆç«‹å³ç”Ÿæ•ˆï¼Œè‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰å‰¯æœ¬ï¼‰
    pub async fn set(&self, key: String, value: SettingValue) -> Result<()> {
        tracing::info!("âš™ï¸  Updating dynamic setting: {} = {:?}", key, value);

        // 1. æ›´æ–°æ•°æ®åº“ï¼ˆæŒä¹…åŒ–ï¼‰
        let (value_str, value_type) = match &value {
            SettingValue::String(s) => (s.clone(), "string"),
            SettingValue::Number(n) => (n.to_string(), "number"),
            SettingValue::Boolean(b) => (b.to_string(), "boolean"),
            SettingValue::Json(j) => (j.to_string(), "json"),
        };

        sqlx::query!(
            "UPDATE settings SET value = $1, updated_at = NOW() WHERE key = $2",
            value_str,
            key
        )
        .execute(&self.db_pool)
        .await?;

        // 2. æ›´æ–°æœ¬åœ°ç¼“å­˜ï¼ˆç«‹å³ç”Ÿæ•ˆï¼‰
        self.cache.insert(key.clone(), value.clone());

        // 3. å‘å¸ƒåˆ° Redis Pub/Subï¼ˆåŒæ­¥åˆ°å…¶ä»–å‰¯æœ¬ï¼‰
        let change = SettingChange {
            key: key.clone(),
            value: value.clone(),
        };

        self.redis_pool
            .publish("settings:changed", serde_json::to_string(&change)?)
            .await?;

        tracing::info!("âœ… Setting updated and synced: {}", key);

        Ok(())
    }

    /// æ‰¹é‡è·å–åˆ†ç±»è®¾ç½®
    pub fn get_category(&self, category: &str) -> Vec<(String, SettingValue)> {
        self.cache
            .iter()
            .filter(|entry| entry.key().starts_with(&format!("{}.", category)))
            .map(|entry| (entry.key().clone(), entry.value().clone()))
            .collect()
    }
}

#[derive(Serialize, Deserialize)]
struct SettingChange {
    key: String,
    value: SettingValue,
}
```

### 6.4 å®æ—¶ç”Ÿæ•ˆæ¼”ç¤º

```rust
// ç¤ºä¾‹ï¼šä¿®æ”¹æˆ¿é—´æœ€å¤§æˆå‘˜æ•°
async fn update_room_settings(settings: &DynamicSettings) -> Result<()> {
    // ä¿®æ”¹å‰
    let old_value = settings.get_number("room.max_members").unwrap_or(10);
    println!("å½“å‰æˆ¿é—´æœ€å¤§æˆå‘˜æ•°: {}", old_value);

    // ä¿®æ”¹è®¾ç½®ï¼ˆé€šè¿‡ Web UI æˆ– CLIï¼‰
    settings.set(
        "room.max_members".to_string(),
        SettingValue::Number(50)
    ).await?;

    // âš¡ ç«‹å³ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯
    // æ‰€æœ‰å‰¯æœ¬é€šè¿‡ Redis Pub/Sub åœ¨æ¯«ç§’çº§åŒæ­¥
    tokio::time::sleep(Duration::from_millis(100)).await;

    let new_value = settings.get_number("room.max_members").unwrap_or(10);
    println!("æ›´æ–°åæˆ¿é—´æœ€å¤§æˆå‘˜æ•°: {}", new_value);  // è¾“å‡º: 50

    // âœ… æ‰€æœ‰å‰¯æœ¬å·²åŒæ­¥ï¼Œä¸šåŠ¡é€»è¾‘ç«‹å³ä½¿ç”¨æ–°å€¼
    Ok(())
}
```

### 6.5 ä¸šåŠ¡é€»è¾‘ä¸­ä½¿ç”¨åŠ¨æ€é…ç½®

```rust
pub struct RoomService {
    db_pool: PgPool,
    dynamic_settings: Arc<DynamicSettings>,  // æ³¨å…¥åŠ¨æ€é…ç½®
}

impl RoomService {
    pub async fn create_room(&self, user_id: i64, name: String) -> Result<Room> {
        // è¯»å–åŠ¨æ€é…ç½®ï¼ˆå®æ—¶ç”Ÿæ•ˆçš„é…ç½®ï¼‰
        let disable_create = self.dynamic_settings
            .get_bool("room.disable_create")
            .unwrap_or(false);

        if disable_create {
            return Err(Error::RoomCreationDisabled);
        }

        let max_per_user = self.dynamic_settings
            .get_number("room.max_per_user")
            .unwrap_or(3);

        // æ£€æŸ¥ç”¨æˆ·åˆ›å»ºçš„æˆ¿é—´æ•°
        let count = sqlx::query_scalar!(
            "SELECT COUNT(*) FROM rooms WHERE creator_id = $1",
            user_id
        )
        .fetch_one(&self.db_pool)
        .await?;

        if count >= max_per_user {
            return Err(Error::RoomLimitExceeded);
        }

        // åˆ›å»ºæˆ¿é—´...
        Ok(room)
    }
}
```

---

## 7. é…ç½®åˆ†ç»„

### 7.1 åˆ†ç»„å®šä¹‰

```rust
pub mod groups {
    /// æœåŠ¡å™¨é…ç½®
    pub const SERVER: &str = "server";

    /// æ•°æ®åº“é…ç½®
    pub const DATABASE: &str = "database";

    /// Redisé…ç½®
    pub const REDIS: &str = "redis";

    /// æˆ¿é—´é…ç½®
    pub const ROOM: &str = "room";

    /// ç”¨æˆ·é…ç½®
    pub const USER: &str = "user";

    /// é‚®ä»¶é…ç½®
    pub const EMAIL: &str = "email";

    /// OAuth2é…ç½®
    pub const OAUTH2: &str = "oauth2";

    /// ä»£ç†é…ç½®
    pub const PROXY: &str = "proxy";

    /// RTMPé…ç½®
    pub const RTMP: &str = "rtmp";

    /// æ—¥å¿—é…ç½®
    pub const LOGGING: &str = "logging";

    /// åŠŸèƒ½å¼€å…³
    pub const FEATURES: &str = "features";
}
```

### 7.2 é™æ€é…ç½®ç»“æ„ä½“

```rust
/// é™æ€é…ç½®ï¼ˆåŸºç¡€è®¾æ–½ï¼Œå¯åŠ¨æ—¶åŠ è½½ï¼‰
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct StaticConfig {
    pub server: ServerConfig,
    pub database: DatabaseConfig,
    pub redis: RedisConfig,
    pub email: EmailConfig,
    pub oauth2: OAuth2Config,
    pub rtmp: RtmpConfig,
    pub logging: LoggingConfig,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ServerConfig {
    pub host: String,
    pub port: u16,
    pub external_url: String,
    pub tls: Option<TlsConfig>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DatabaseConfig {
    pub url: String,
    pub max_connections: u32,
    pub min_connections: u32,
    pub connect_timeout: u64,
}
```

### 7.3 åŠ¨æ€é…ç½®å‘½åè§„èŒƒ

åŠ¨æ€é…ç½®ä½¿ç”¨ **ç‚¹åˆ†éš”å‘½å**ï¼Œå­˜å‚¨åœ¨ settings è¡¨ï¼š

| åˆ†ç±» | é…ç½®é”®ç¤ºä¾‹ | ç±»å‹ | è¯´æ˜ |
|-----|----------|------|------|
| **room** | `room.disable_create` | boolean | ç¦ç”¨æˆ¿é—´åˆ›å»º |
| | `room.require_approval` | boolean | æˆ¿é—´éœ€è¦å®¡æ ¸ |
| | `room.max_members` | number | æˆ¿é—´æœ€å¤§æˆå‘˜æ•° |
| | `room.ttl_hours` | number | æˆ¿é—´TTLï¼ˆå°æ—¶ï¼‰ |
| **user** | `user.disable_signup` | boolean | ç¦ç”¨ç”¨æˆ·æ³¨å†Œ |
| | `user.require_approval` | boolean | ç”¨æˆ·éœ€è¦å®¡æ ¸ |
| | `user.max_room_count` | number | æ¯ç”¨æˆ·æœ€å¤šåˆ›å»ºæˆ¿é—´æ•° |
| | `user.enable_guest` | boolean | å¯ç”¨æ¸¸å®¢æ¨¡å¼ |
| **proxy** | `proxy.enable_movie` | boolean | å¯ç”¨ç”µå½±ä»£ç† |
| | `proxy.enable_live` | boolean | å¯ç”¨ç›´æ’­ä»£ç† |
| **rate_limit** | `rate_limit.chat_per_user` | number | èŠå¤©é™æµï¼ˆæ¡/ç§’ï¼‰ |
| | `rate_limit.danmaku_per_user` | number | å¼¹å¹•é™æµï¼ˆæ¡/ç§’ï¼‰ |

**è¯»å–ç¤ºä¾‹**ï¼š

```rust
// è¯»å–åŠ¨æ€é…ç½®
let max_members = dynamic_settings.get_number("room.max_members").unwrap_or(10);
let disable_signup = dynamic_settings.get_bool("user.disable_signup").unwrap_or(false);
```

---

## 8. å®ç°æ–¹æ¡ˆ

### 8.1 ä¾èµ–åº“

```toml
[dependencies]
config = "0.14"                 # é™æ€é…ç½®åŠ è½½
serde = { version = "1.0", features = ["derive"] }
clap = { version = "4.4", features = ["derive"] }
sqlx = { version = "0.7", features = ["postgres", "runtime-tokio-rustls"] }
redis = { version = "0.24", features = ["tokio-comp", "connection-manager"] }
dashmap = "5.5"                 # åŠ¨æ€é…ç½®å†…å­˜ç¼“å­˜
```

### 8.2 å®Œæ•´åˆå§‹åŒ–æµç¨‹

```rust
use config::{Config, File, Environment};

/// åº”ç”¨ç¨‹åºçŠ¶æ€ï¼ˆåŒ…å«é™æ€å’ŒåŠ¨æ€é…ç½®ï¼‰
pub struct AppState {
    /// é™æ€é…ç½®ï¼ˆå¯åŠ¨æ—¶åŠ è½½ï¼Œéœ€è¦é‡å¯ç”Ÿæ•ˆï¼‰
    pub static_config: Arc<StaticConfig>,

    /// åŠ¨æ€é…ç½®ï¼ˆè¿è¡Œæ—¶å¯ä¿®æ”¹ï¼Œå®æ—¶ç”Ÿæ•ˆï¼‰
    pub dynamic_settings: Arc<DynamicSettings>,

    /// æ•°æ®åº“è¿æ¥æ± 
    pub db_pool: PgPool,

    /// Redis è¿æ¥æ± 
    pub redis_pool: RedisPool,
}

impl AppState {
    /// åˆå§‹åŒ–åº”ç”¨ç¨‹åºï¼ˆå¯åŠ¨æµç¨‹ï¼‰
    pub async fn init(cli: Cli) -> Result<Self> {
        tracing::info!("ğŸš€ Initializing SyncTV server");

        // ============ ç¬¬ä¸€æ­¥ï¼šåŠ è½½é™æ€é…ç½® ============
        tracing::info!("ğŸ“ Loading static configuration...");
        let static_config = load_static_config(&cli).await?;
        tracing::info!("âœ… Static configuration loaded");

        // ============ ç¬¬äºŒæ­¥ï¼šè¿æ¥åŸºç¡€è®¾æ–½ ============
        tracing::info!("ğŸ”Œ Connecting to database...");
        let db_pool = PgPoolOptions::new()
            .max_connections(static_config.database.max_connections)
            .connect(&static_config.database.url)
            .await?;
        tracing::info!("âœ… Database connected");

        tracing::info!("ğŸ”Œ Connecting to Redis...");
        let redis_pool = RedisPool::new(&static_config.redis.url).await?;
        tracing::info!("âœ… Redis connected");

        // ============ ç¬¬ä¸‰æ­¥ï¼šåˆå§‹åŒ–åŠ¨æ€é…ç½®ç³»ç»Ÿ ============
        tracing::info!("âš™ï¸  Initializing dynamic settings...");
        let dynamic_settings = DynamicSettings::init(&db_pool, &redis_pool).await?;
        tracing::info!("âœ… Dynamic settings initialized");

        Ok(Self {
            static_config: Arc::new(static_config),
            dynamic_settings: Arc::new(dynamic_settings),
            db_pool,
            redis_pool,
        })
    }
}

/// åŠ è½½é™æ€é…ç½®ï¼ˆCLI + ENV + Fileï¼‰
async fn load_static_config(cli: &Cli) -> Result<StaticConfig> {
    let mut builder = Config::builder();

    // 1. åŠ è½½é»˜è®¤å€¼
    builder = builder.add_source(Config::try_from(&StaticConfig::default())?);

    // 2. åŠ è½½é…ç½®æ–‡ä»¶ (é™¤é --skip-config)
    if !cli.skip_config {
        builder = builder.add_source(
            File::with_name(cli.config.to_str().unwrap())
                .required(false)
        );
    }

    // 3. åŠ è½½ç¯å¢ƒå˜é‡ (é™¤é --skip-env)
    if !cli.skip_env {
        builder = builder.add_source(
            Environment::with_prefix("SYNCTV")
                .separator("_")
                .try_parsing(true)
        );
    }

    // 4. åº”ç”¨CLIå‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    builder = apply_cli_overrides(builder, cli);

    // 5. æ„å»ºé™æ€é…ç½®
    let config = builder.build()?.try_deserialize::<StaticConfig>()?;

    // 6. éªŒè¯é™æ€é…ç½®
    config.validate()?;

    Ok(config)
}
```

### 8.3 é™æ€é…ç½®éªŒè¯

```rust
impl StaticConfig {
    /// éªŒè¯é™æ€é…ç½®çš„æœ‰æ•ˆæ€§
    pub fn validate(&self) -> Result<()> {
        // éªŒè¯æ•°æ®åº“URL
        if self.database.url.is_empty() {
            return Err(Error::InvalidConfig("database.url is required"));
        }

        // éªŒè¯Redis URL
        if self.redis.url.is_empty() {
            return Err(Error::InvalidConfig("redis.url is required"));
        }

        // éªŒè¯ç«¯å£èŒƒå›´
        if self.server.port == 0 || self.server.port > 65535 {
            return Err(Error::InvalidConfig("server.port must be 1-65535"));
        }

        // éªŒè¯OAuth2é…ç½®å®Œæ•´æ€§
        for (name, provider) in &self.oauth2.providers {
            if provider.enabled {
                if provider.client_id.is_empty() {
                    return Err(Error::InvalidConfig(
                        format!("oauth2.{}.client_id is required", name)
                    ));
                }
                if provider.client_secret.is_empty() {
                    return Err(Error::InvalidConfig(
                        format!("oauth2.{}.client_secret is required", name)
                    ));
                }
            }
        }

        // éªŒè¯é‚®ä»¶é…ç½®
        if self.email.enabled {
            if self.email.smtp_host.is_empty() {
                return Err(Error::InvalidConfig("email.smtp_host is required"));
            }
        }

        Ok(())
    }
}
```

### 8.4 ä½¿ç”¨ç¤ºä¾‹ï¼šåŒæ—¶ä½¿ç”¨é™æ€å’ŒåŠ¨æ€é…ç½®

```rust
#[tokio::main]
async fn main() -> Result<()> {
    // è§£æCLIå‚æ•°
    let cli = Cli::parse();

    // åˆå§‹åŒ–åº”ç”¨ï¼ˆåŠ è½½é™æ€é…ç½® + åŠ¨æ€é…ç½®ï¼‰
    let app_state = AppState::init(cli).await?;

    // ============ ä½¿ç”¨é™æ€é…ç½® ============
    // é™æ€é…ç½®åœ¨å¯åŠ¨æ—¶ç¡®å®šï¼Œä¿®æ”¹åéœ€è¦é‡å¯
    let addr = format!("{}:{}",
        app_state.static_config.server.host,
        app_state.static_config.server.port
    );
    tracing::info!("Server listening on {}", addr);

    // ============ ä½¿ç”¨åŠ¨æ€é…ç½® ============
    // åŠ¨æ€é…ç½®å¯è¿è¡Œæ—¶ä¿®æ”¹ï¼Œå®æ—¶ç”Ÿæ•ˆ
    let max_members = app_state.dynamic_settings
        .get_number("room.max_members")
        .unwrap_or(10);
    tracing::info!("Room max members: {}", max_members);

    // å¯åŠ¨æœåŠ¡å™¨
    start_server(app_state, &addr).await?;

    Ok(())
}

/// ä¸šåŠ¡é€»è¾‘ä¸­åŒæ—¶ä½¿ç”¨ä¸¤ç§é…ç½®
async fn handle_create_room(
    app_state: &AppState,
    user_id: i64,
) -> Result<Room> {
    // ä½¿ç”¨åŠ¨æ€é…ç½®ï¼ˆå¯è¿è¡Œæ—¶ä¿®æ”¹ï¼‰
    let disable_create = app_state.dynamic_settings
        .get_bool("room.disable_create")
        .unwrap_or(false);

    if disable_create {
        return Err(Error::RoomCreationDisabled);
    }

    // ä½¿ç”¨é™æ€é…ç½®ï¼ˆéœ€è¦é‡å¯æ‰èƒ½ä¿®æ”¹ï¼‰
    let external_url = &app_state.static_config.server.external_url;

    // åˆ›å»ºæˆ¿é—´é€»è¾‘...
    Ok(room)
}
```

---

## æ€»ç»“

æœ¬ç« èŠ‚è®¾è®¡äº†ä¸€ä¸ª**åŒå±‚é…ç½®ç³»ç»Ÿ**ï¼Œä¸¥æ ¼åŒºåˆ†é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®ï¼š

### é™æ€é…ç½®ï¼ˆåŸºç¡€è®¾æ–½ï¼‰

âœ… **æ¥æº**: CLI > ç¯å¢ƒå˜é‡ > é…ç½®æ–‡ä»¶ > é»˜è®¤å€¼
âœ… **ç”Ÿæ•ˆæ–¹å¼**: å¯åŠ¨æ—¶åŠ è½½ï¼Œ**ä¿®æ”¹åéœ€è¦é‡å¯**
âœ… **ç”¨é€”**: æ•°æ®åº“è¿æ¥ã€Redisè¿æ¥ã€æœåŠ¡å™¨ç«¯å£ã€TLSè¯ä¹¦ã€OAuth2å‡­è¯ç­‰
âœ… **ç¤ºä¾‹**: `--port 8080`, `DATABASE_URL=postgres://...`

### åŠ¨æ€é…ç½®ï¼ˆä¸šåŠ¡è§„åˆ™ï¼‰

âœ… **æ¥æº**: PostgreSQL settings è¡¨
âœ… **ç”Ÿæ•ˆæ–¹å¼**: **å®æ—¶ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯**
âœ… **å¤šå‰¯æœ¬åŒæ­¥**: é€šè¿‡ Redis Pub/Sub æ¯«ç§’çº§åŒæ­¥
âœ… **ç”¨é€”**: æˆ¿é—´é™åˆ¶ã€ç”¨æˆ·æƒé™ã€åŠŸèƒ½å¼€å…³ã€é™æµé…ç½®ç­‰
âœ… **ä¿®æ”¹æ–¹å¼**: Web UIã€CLI å‘½ä»¤ (`synctv setting set`)

### æ ¸å¿ƒåŸåˆ™

âš ï¸ **é™æ€é…ç½®å’ŒåŠ¨æ€é…ç½®æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„ç³»ç»Ÿ**
âš ï¸ **å®ƒä»¬æ²¡æœ‰ä¼˜å…ˆçº§å…³ç³»ï¼Œç®¡ç†ä¸åŒç±»å‹çš„é…ç½®é¡¹**
âš ï¸ **é™æ€é…ç½® â‰  åŠ¨æ€é…ç½®ï¼Œä¸è¦æ··ä¸ºä¸€è°ˆ**

### è®¾è®¡ä¼˜åŠ¿

âœ… **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶ç±»å‹æ£€æŸ¥,è¿è¡Œæ—¶éªŒè¯
âœ… **å¤šå‰¯æœ¬æ”¯æŒ**: åŠ¨æ€é…ç½®é€šè¿‡ Redis Pub/Sub å®æ—¶åŒæ­¥
âœ… **æ˜“äºéƒ¨ç½²**: Dockerã€Kubernetesã€è£¸æœºéƒ½æ”¯æŒ
âœ… **è°ƒè¯•å‹å¥½**: å¯è¿½è¸ªæ¯ä¸ªé…ç½®å€¼çš„æ¥æº
âœ… **è¿è¥å‹å¥½**: åŠ¨æ€é…ç½®æ”¯æŒçƒ­æ›´æ–°ï¼Œæ— éœ€é‡å¯æœåŠ¡

**ä¸‹ä¸€ç« **: [20-CLIå‘½ä»¤è®¾è®¡](./20-CLIå‘½ä»¤è®¾è®¡.md)

---

**ä¸Šä¸€ç« **: [18-APIæ–‡æ¡£ç”Ÿæˆæ–¹æ¡ˆ](./18-APIæ–‡æ¡£ç”Ÿæˆæ–¹æ¡ˆ.md)
**ä¸‹ä¸€ç« **: [20-CLIå‘½ä»¤è®¾è®¡](./20-CLIå‘½ä»¤è®¾è®¡.md)
