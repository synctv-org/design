# Rust SyncTV 实施路线图

---

## 📖 相关文档

本路线图基于以下设计文档：

- **[01-项目概述](./01-项目概述.md)** - 项目背景、核心特性、技术栈
- **[02-整体架构](./02-整体架构.md)** - 系统架构、多副本设计
- **[04-数据库设计](./04-数据库设计.md)** - 完整的数据库表结构
- **[06-用户系统设计](./06-用户系统设计.md)** - 用户认证与授权
- **[07-权限系统设计](./07-权限系统设计.md)** - 权限位掩码系统
- **[08-视频内容管理](./08-视频内容管理.md)** - 视频解析与代理
- **[11-实时互动](./11-实时互动.md)** - 聊天与弹幕系统
- **[14-通信架构设计](./14-通信架构设计.md)** - gRPC 三层架构
- **[16-实时消息流](./16-实时消息流.md)** - gRPC Streaming 双向流
- **[17-数据流设计](./17-数据流设计.md)** - 直播流处理
- **[22-部署方案](./22-部署方案.md)** - Kubernetes 部署

查看完整文档列表：**[README.md](./README.md)**

---

## 📋 项目总览

### 目标

将 Go 版本的 SyncTV 重构为 Rust 实现，支持 Kubernetes 多副本部署，提供高性能、高可用的同步观影平台。

### 关键指标

- **性能**: 单副本支持 1000+ 并发连接，50+ 并发直播流
- **可用性**: 99.9% SLA，支持副本故障自动转移
- **延迟**: gRPC streaming 消息延迟 < 50ms，直播延迟 < 3s
- **扩展性**: 支持水平扩展至 10+ 副本

---

## 🎯 开发阶段

### Phase 1: 基础框架 (4周)

**目标**: 搭建项目基础框架，实现核心数据模型

#### Week 1-2: 项目初始化

- [ ] **项目结构搭建**
  - Cargo workspace 配置
  - 模块划分 (synctv-core, synctv-api, synctv-stream)
  - 开发环境配置 (rustfmt, clippy)
  - CI/CD 基础 (GitHub Actions)

- [ ] **数据库设计与实现** (详见 [04-数据库设计](./04-数据库设计.md))
  - PostgreSQL 数据库表结构 (9张核心表)
  - SQLx 集成与连接池配置
  - 数据库迁移脚本
  - 基础 Repository 实现

- [ ] **配置管理** (详见 [19-配置管理系统](./19-配置管理系统.md))
  - 配置文件结构 (config crate)
  - 环境变量支持
  - 多环境配置 (dev/staging/prod)
  - 配置优先级与热重载

**交付物**:

- 可运行的项目骨架
- 数据库迁移脚本
- 基础配置文档

#### Week 3-4: 用户与认证

- [ ] **用户管理模块** (详见 [06-用户系统设计](./06-用户系统设计.md))
  - User model 与 Repository
  - 用户注册/登录/注销
  - 密码加密 (Argon2id)
  - 用户信息管理
  - OAuth2 集成

- [ ] **认证授权系统** (详见 [07-权限系统设计](./07-权限系统设计.md))
  - RS256 JWT token 生成与验证
  - Token 刷新机制
  - Token 黑名单 (Redis)
  - 64位权限位掩码设计
  - 角色与状态分离

- [ ] **基础 gRPC API** (详见 [14-通信架构设计](./14-通信架构设计.md))
  - tonic 框架集成
  - Protobuf 定义
  - 认证拦截器
  - 错误处理
  - gRPC-Web 支持

**交付物**:

- 用户注册/登录 gRPC API
- JWT 认证拦截器
- Protobuf API 定义

**里程碑 M1**: ✅ 用户可以注册、登录并获取 token

---

### Phase 2: 房间与同步 (4周)

**目标**: 实现房间管理、播放同步、gRPC streaming 实时通信

#### Week 5-6: 房间管理

- [ ] **房间核心功能**
  - Room model 与 Repository
  - 创建/更新/删除房间
  - 房间成员管理
  - 权限检查

- [ ] **影片管理**
  - Movie model 与 Repository
  - 添加/删除影片
  - 切换当前播放影片
  - 播放状态管理

- [ ] **房间状态同步**
  - 播放/暂停控制
  - 跳转时间同步
  - 播放速率同步
  - 状态持久化

**交付物**:

- 房间管理 API
- 影片管理 API
- 播放控制 API

#### Week 7-8: gRPC Streaming 实时通信

- [ ] **gRPC Streaming 基础** (详见 [16-实时消息流](./16-实时消息流.md))
  - MessageStream RPC 实现 (bidirectional streaming)
  - 双向流管理
  - 心跳机制
  - 断线重连支持

- [ ] **消息路由** (详见 [16-实时消息流](./16-实时消息流.md) § 10.6)
  - RoomMessageHub 实现 (Redis Pub/Sub)
  - 跨节点消息分发
  - Protobuf 消息序列化
  - 消息类型定义

- [ ] **实时同步** (详见 [12-时间同步与补偿](./12-时间同步与补偿.md))
  - 播放状态广播
  - 成员加入/离开通知
  - 聊天消息实时推送
  - 时间同步与延迟补偿
  - 错误消息处理

**交付物**:

- gRPC bidirectional streaming
- 实时播放同步功能
- 客户端测试工具

**里程碑 M2**: ✅ 用户可以创建房间并实时同步播放状态

---

### Phase 3: 直播流集成 (4周)

**目标**: 集成 xiu 流媒体引擎，实现 RTMP/HLS/FLV 支持

#### Week 9-10: Xiu 集成

- [ ] **Xiu 基础集成** (详见 [17-数据流设计](./17-数据流设计.md))
  - xiu 依赖引入
  - RTMP 服务器启动
  - HTTP 服务器启动 (HLS/FLV)
  - StreamHub 集成

- [ ] **推流处理** (详见 [17-数据流设计](./17-数据流设计.md) § 11.1)
  - RTMP 推流认证
  - Stream key 验证
  - 推流事件监听 (on_publish)
  - GOP 缓存实现
  - Publisher 原子注册 (Redis HSETNX)

- [ ] **流注册管理** (详见 [02-整体架构](./02-整体架构.md) § 2.2.2)
  - Redis 流注册 (stream:{key} → publisher_node_id)
  - 推流节点记录
  - 心跳维护
  - 流状态管理
  - 流超时清理 (TTL)

**交付物**:

- RTMP 推流支持
- 流注册到 Redis
- 基础监控指标

#### Week 11-12: 拉流与分发

- [ ] **播放地址生成** (详见 [17-数据流设计](./17-数据流设计.md) § 11.2)
  - HLS 播放地址 API
  - FLV 播放地址 API
  - Publisher 节点查询
  - 透明代理逻辑

- [ ] **跨节点拉流** (详见 [02-整体架构](./02-整体架构.md) § 2.2.2 - 懒加载模式)
  - 懒加载拉流机制 (收到FLV请求时才创建)
  - RTMP Client 实现
  - HLS 切片代理 (从 Publisher 获取)
  - 本地缓存管理
  - 自动清理无订阅者的拉流

- [ ] **本地分发**
  - HLS 切片服务
  - FLV 流推送
  - GOP 缓存复用
  - 客户端连接管理
  - OSS 存储集成 (可选)

**交付物**:

- HLS/FLV 播放支持
- 跨节点流转发
- 直播延迟 < 3s

**里程碑 M3**: ✅ 用户可以推流到任意节点，其他节点可以正常播放

---

### Phase 4: 多副本与集群 (3周)

**目标**: 实现多副本部署、集群同步、服务发现

#### Week 13-14: 集群同步

- [ ] **Redis Pub/Sub** (详见 [16-实时消息流](./16-实时消息流.md) § 10.6)
  - 集群事件定义 (ClusterEvent)
  - 事件发布 (publish)
  - 事件订阅 (subscribe)
  - 事件处理器 (EventHandler)
  - 跨节点消息分发

- [ ] **节点注册** (详见 [02-整体架构](./02-整体架构.md) § 2.3)
  - Kubernetes Headless Service 服务发现
  - 节点心跳机制
  - 节点列表维护
  - 节点下线检测

- [ ] **房间状态同步** (详见 [05-缓存设计](./05-缓存设计.md))
  - 播放控制同步
  - 成员变更同步
  - 聊天消息同步
  - 跨节点广播
  - 缓存一致性保证

**交付物**:

- 集群事件系统
- 跨节点状态同步
- 节点注册与发现

#### Week 15: gRPC 集群通信

- [ ] **gRPC 服务定义** (详见 [15-API接口定义](./15-API接口定义.md))
  - proto 文件定义 (cluster.proto)
  - 代码生成 (tonic-build)
  - ClusterService 实现

- [ ] **流转发服务** (详见 [17-数据流设计](./17-数据流设计.md))
  - PullRtmpStream (懒加载拉取 RTMP 流)
  - GetStreamStatus (查询流状态)
  - StreamHealthCheck (流健康检查)

- [ ] **数据同步服务** (详见 [15-API接口定义](./15-API接口定义.md))
  - SyncRoomState (同步房间状态)
  - GetUserOnlineStatus (查询用户在线状态)
  - BroadcastEvent (广播集群事件)

**交付物**:

- gRPC 服务实现
- 跨节点流转发测试通过
- 同步延迟 < 100ms

**里程碑 M4**: ✅ 多副本部署正常工作，状态同步正常

---

### Phase 5: 业务功能 (3周)

**目标**: 实现视频解析、代理、聊天、弹幕等业务功能

#### Week 16: 视频内容管理

- [ ] **视频解析系统** (详见 [08-视频内容管理](./08-视频内容管理.md))
  - MediaProvider trait 定义
  - BilibiliProvider 实现
  - AlistProvider 实现
  - EmbyProvider 实现
  - MediaProviderRegistry 注册表
  - 三阶段工作流 (parse → add → play)

- [ ] **媒体源配置管理** (详见 [09-媒体源提供商配置管理](./09-媒体源提供商配置管理.md))
  - ProviderConfig 表设计
  - 凭证管理与加密
  - 本地实例 + 远程实例架构
  - 自动降级机制

- [ ] **代理系统** (详见 [10-视频链接过期与代理机制](./10-视频链接过期与代理机制.md))
  - ProxyService 实现
  - 多级缓存 (内存+Redis+文件)
  - 请求去重 (RequestDeduplicator)
  - 布隆过滤器 (防缓存穿透)
  - JWT URL 过期与宽限期

- [ ] **字幕系统** (详见 [08-视频内容管理](./08-视频内容管理.md) § 6.5)
  - 字幕格式定义 (SRT/VTT/ASS)
  - SubtitleConverter 实现
  - 格式转换逻辑
  - 字幕代理服务

**交付物**:

- 视频解析 API
- 代理服务 API
- 字幕格式转换

#### Week 17: 实时互动

- [ ] **聊天系统** (详见 [11-实时互动](./11-实时互动.md) § 7.1)
  - ChatMessage model
  - 发送聊天消息
  - 聊天历史查询 (最近500条)
  - 数据库自动清理触发器
  - gRPC Streaming 实时广播
  - 消息删除功能

- [ ] **弹幕系统** (详见 [11-实时互动](./11-实时互动.md) § 7.2)
  - Danmaku model (纯内存，无数据库)
  - 发送弹幕 API
  - 弹幕内存缓存 (最近10秒/100条)
  - gRPC Streaming 实时广播
  - 新用户快速同步

- [ ] **Bilibili 弹幕对接** (详见 [11-实时互动](./11-实时互动.md) § 7.3)
  - BilibiliDanmakuClient 实现
  - WebSocket 连接 (Bilibili 直播 API)
  - 消息解压 (zlib/brotli)
  - 弹幕转发到房间 gRPC stream

**交付物**:

- 聊天功能
- 弹幕功能
- Bilibili 弹幕转发

#### Week 18: 内容过滤与限流

- [ ] **内容过滤** (详见 [11-实时互动](./11-实时互动.md) § 7.4)
  - ContentFilter 实现
  - HTML 清理 (ammonia)
  - 敏感词过滤
  - XSS 防护
  - 正则过滤规则

- [ ] **Rate Limiting** (详见 [11-实时互动](./11-实时互动.md) § 7.4.2)
  - Redis INCR + EXPIRE 实现
  - 全局限流
  - 用户级限流
  - 消息类型限流
  - 聊天: 10条/秒，弹幕: 3条/秒

- [ ] **权限系统完善** (详见 [07-权限系统设计](./07-权限系统设计.md))
  - 64位权限位掩码完整实现
  - 权限检查中间件
  - 动态权限调整
  - 权限继承 (Creator → Custom → Role → Global)

- [ ] **自动连播功能** (详见 [13-自动连播设计](./13-自动连播设计.md))
  - 播放模式 (顺序/单曲循环/列表循环/随机)
  - PlaylistTree 树结构支持目录
  - 深度优先遍历算法
  - 房间级配置

**交付物**:

- 内容过滤系统
- 完整的限流机制
- 权限系统测试

**里程碑 M5**: ✅ 所有业务功能开发完成

---

### Phase 6: 部署与优化 (3周)

**目标**: Kubernetes 部署、监控、性能优化

#### Week 19: Kubernetes 部署

- [ ] **部署配置** (详见 [22-部署方案](./22-部署方案.md))
  - Deployment YAML
  - Service (Headless - 支持副本间通信)
  - ConfigMap
  - Secret
  - Ingress (支持 gRPC/HTTP2)
  - HPA (水平扩缩容)

- [ ] **数据库与缓存** (详见 [22-部署方案](./22-部署方案.md) § 13.2-13.3)
  - PostgreSQL StatefulSet
  - Redis Cluster 部署
  - PVC 持久化存储
  - 数据备份策略

- [ ] **部署脚本与工具** (详见 [22-部署方案](./22-部署方案.md) § 13.6)
  - Helm Charts 封装
  - 初始化部署脚本
  - 滚动更新脚本
  - 回滚脚本
  - 健康检查探针
  - CLI 工具集成 (详见 [20-CLI命令设计](./20-CLI命令设计.md))

**交付物**:

- 完整的 K8s 部署配置
- 部署文档
- 一键部署脚本

#### Week 20: 监控与日志

- [ ] **Prometheus 监控** (详见 [23-监控优化](./23-监控优化.md))
  - 指标定义 (active_rooms, active_streams, connected_users, grpc_streaming_connections)
  - Metrics 端点 (/metrics)
  - ServiceMonitor 配置
  - Grafana Dashboard

- [ ] **日志系统** (详见 [23-监控优化](./23-监控优化.md) § 14.2)
  - 结构化日志 (tracing-subscriber)
  - 日志输出到 stdout/stderr
  - Kubernetes 日志自动收集
  - 日志级别动态调整

- [ ] **告警配置** (详见 [23-监控优化](./23-监控优化.md) § 14.3)
  - AlertManager 规则
  - 告警通知 (钉钉/企微/邮件)
  - 告警分级
  - 告警收敛

**交付物**:

- Prometheus + Grafana 监控
- 结构化日志系统 (tracing)
- 告警规则

#### Week 21: 性能优化

- [ ] **数据库优化** (详见 [04-数据库设计](./04-数据库设计.md) § 4)
  - 索引优化
  - 查询优化
  - 连接池调优
  - 慢查询分析

- [ ] **缓存优化** (详见 [05-缓存设计](./05-缓存设计.md))
  - Redis Pipeline
  - 缓存预热
  - 缓存淘汰策略 (LRU/LFU)
  - 本地缓存优化
  - 缓存一致性保证

- [ ] **并发优化** (详见 [21-关键实现](./21-关键实现.md))
  - 零拷贝优化
  - 并发控制调优
  - 内存管理优化
  - Tokio 运行时配置
  - DashMap 并发 HashMap

- [ ] **压力测试** (详见 [23-监控优化](./23-监控优化.md) § 14.6)
  - 并发连接测试 (1000+)
  - 直播流压测 (50+)
  - gRPC streaming 压测
  - 延迟测试 (<50ms)
  - 瓶颈分析与调优

**交付物**:

- 性能测试报告
- 优化建议文档
- 达成性能指标

**里程碑 M6**: ✅ 生产环境部署成功，性能达标

---

### Phase 7: 安全与收尾 (2周)

**目标**: 安全加固、文档完善、测试验收

#### Week 22: 安全加固

- [ ] **安全审计** (详见 [24-安全故障](./24-安全故障.md))
  - 依赖漏洞扫描 (cargo-audit)
  - 代码安全审查
  - API 安全测试
  - 渗透测试

- [ ] **安全加固** (详见 [24-安全故障](./24-安全故障.md))
  - HTTPS/TLS 配置
  - CORS 配置
  - CSP 配置
  - Rate limiting 强化
  - RS256 JWT (非对称加密)
  - Argon2id 密码哈希

- [ ] **数据安全** (详见 [04-数据库设计](./04-数据库设计.md) § 7)
  - 敏感数据加密 (AES-256-GCM)
  - 凭证加密存储
  - 备份加密
  - 审计日志
  - GDPR 合规

**交付物**:

- 安全审计报告
- 安全加固文档
- 合规性报告

#### Week 23: 文档与验收

- [ ] **文档完善** (详见 [18-API文档生成方案](./18-API文档生成方案.md))
  - OpenAPI 3.0 文档自动生成 (utoipa)
  - Swagger UI / Redoc 集成
  - gRPC Server Reflection
  - 部署文档
  - 运维手册
  - 故障处理手册

- [ ] **用户文档**
  - 用户使用指南
  - 常见问题 FAQ
  - 视频教程
  - 客户端集成示例 (gRPC/gRPC-Web/HTTP)

- [ ] **测试验收**
  - 功能测试 (所有API)
  - 集成测试 (多副本场景)
  - 端到端测试 (完整业务流程)
  - 性能验收 (达成目标指标)

**交付物**:

- 完整的文档集
- 测试报告
- 验收报告

**里程碑 M7**: ✅ 项目交付，生产环境稳定运行

---

## 📊 资源规划

### 人员配置

| 角色 | 人数 | 主要职责 |
|-----|------|---------|
| 后端开发 | 2-3人 | Rust 开发、API 实现、业务逻辑 |
| 流媒体工程师 | 1人 | xiu 集成、流处理、性能优化 |
| 前端开发 | 1-2人 | Web UI、播放器集成、WebSocket |
| DevOps | 1人 | K8s 部署、CI/CD、监控告警 |
| 测试 | 1人 | 测试用例、自动化测试、压测 |

### 技术栈

**后端**:

- Rust 1.75+
- Axum 0.7
- Tokio 1.35
- SQLx 0.7
- Redis 0.24
- xiu (latest)
- tonic 0.11

**数据库**:

- PostgreSQL 15
- Redis 7

**部署**:

- Kubernetes 1.28+
- Docker
- Prometheus + Grafana

---

## 🎲 风险与缓解

### 技术风险

| 风险 | 影响 | 概率 | 缓解措施 |
|-----|------|------|---------|
| xiu 集成复杂度高 | 高 | 中 | 提前技术预研，准备备选方案 |
| 多副本状态同步问题 | 高 | 中 | 充分测试，设计降级策略 |
| 性能不达标 | 中 | 低 | 提前压测，预留优化时间 |
| Rust 学习曲线 | 中 | 中 | 代码评审，技术分享 |

### 进度风险

| 风险 | 影响 | 概率 | 缓解措施 |
|-----|------|------|---------|
| 需求变更频繁 | 高 | 中 | 需求冻结，变更控制 |
| 人员流失 | 高 | 低 | 文档完善，知识沉淀 |
| 依赖延期 | 中 | 低 | 提前对接，备选方案 |

---

## 📈 成功标准

### 功能完整性

- ✅ 所有核心功能实现
- ✅ API 覆盖率 100%
- ✅ 单元测试覆盖率 > 70%
- ✅ 集成测试通过

### 性能指标

- ✅ 单副本 1000+ 并发连接
- ✅ 50+ 并发直播流
- ✅ gRPC Streaming 延迟 < 50ms (P95)
- ✅ 直播延迟 < 3s (HLS)
- ✅ HTTP API P95 响应时间 < 200ms

### 可用性

- ✅ 99.9% SLA
- ✅ 副本故障自动转移
- ✅ 零停机滚动更新
- ✅ 数据不丢失

### 安全性

- ✅ 无高危漏洞
- ✅ 通过安全审计
- ✅ 敏感数据加密
- ✅ 完整审计日志

---

## 🔄 迭代计划

### v1.0 (MVP)

- 核心功能完整
- 单副本部署
- 基础监控

### v1.1 (多副本)

- 多副本支持
- 集群同步
- 直播流转发

### v1.2 (业务增强)

- 视频解析
- 弹幕系统
- 权限完善

### v2.0 (生产就绪)

- 性能优化
- 安全加固
- 完整监控
